<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>minerOS Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="description" content="Dashboard m√≥vil minerOS para consulta r√°pida de proyectos y capturas" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="minerOS" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png" />

    <style>
      :root {
        --bg: #0f172a;
        --bg-soft: #1e293b;
        --card: #0f172a;
        --border: #334155;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.15);
        --text: #f1f5f9;
        --muted: #94a3b8;
        --danger: #ef4444;
        --warn: #f59e0b;
        --ok: #22c55e;
        --purple: #a855f7;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 15px;
        line-height: 1.5;
        min-height: 100vh;
        min-height: 100dvh;
        overflow-x: hidden;
      }

      /* ===== APP CONTAINER ===== */
      .app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        min-height: 100dvh;
      }

      .view {
        display: none;
        flex: 1;
        padding: 1rem;
        padding-bottom: 5rem;
        overflow-y: auto;
      }

      .view.active {
        display: block;
      }

      /* ===== HEADER ===== */
      .header {
        padding: 1rem;
        padding-top: max(1rem, env(safe-area-inset-top));
        background: linear-gradient(180deg, var(--bg-soft) 0%, var(--bg) 100%);
        border-bottom: 1px solid var(--border);
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-date {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.65rem;
        background: var(--accent-soft);
        border: 1px solid var(--accent);
        border-radius: 999px;
        font-size: 0.75rem;
        color: var(--accent);
      }

      .status-pill .dot {
        width: 6px;
        height: 6px;
        background: var(--accent);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* ===== CARDS ===== */
      .card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .card-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: var(--accent-soft);
        color: var(--accent);
        border-radius: 999px;
      }

      /* ===== HOME VIEW ===== */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
      }

      .stat-value.ok { color: var(--ok); }
      .stat-value.warn { color: var(--warn); }
      .stat-value.purple { color: var(--purple); }

      .stat-label {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      /* Activity Graph */
      .activity-graph {
        display: flex;
        align-items: flex-end;
        gap: 3px;
        height: 50px;
        padding: 0.5rem 0;
      }

      .activity-bar {
        flex: 1;
        background: var(--border);
        border-radius: 2px;
        min-height: 4px;
        transition: all 0.3s ease;
      }

      .activity-bar.active {
        background: var(--accent);
      }

      .activity-bar.today {
        background: var(--ok);
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
      }

      /* Session Timer */
      .session-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
      }

      .session-card.active {
        border-color: var(--ok);
        background: rgba(34, 197, 94, 0.08);
      }

      .session-timer {
        font-size: 2.5rem;
        font-weight: 700;
        font-family: "SF Mono", Monaco, monospace;
        color: var(--text);
        margin: 0.5rem 0;
      }

      .session-card.active .session-timer {
        color: var(--ok);
      }

      .session-label {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .session-btn {
        width: 100%;
        padding: 0.75rem;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        border: none;
        margin-top: 0.75rem;
        transition: all 0.15s ease;
      }

      .session-btn.start {
        background: var(--ok);
        color: white;
      }

      .session-btn.stop {
        background: var(--danger);
        color: white;
      }

      .session-btn:active {
        transform: scale(0.98);
      }

      /* Project Mini Cards */
      .project-mini {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 12px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .project-mini:hover, .project-mini:active {
        background: var(--accent-soft);
        transform: scale(0.98);
      }

      .project-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-soft);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .project-info {
        flex: 1;
        min-width: 0;
      }

      .project-name {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .project-meta {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .project-status {
        font-size: 0.65rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-weight: 500;
      }

      .project-status.production {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .project-status.development {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .project-status.idea {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .project-status.prototype {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .project-status.archived {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
      }

      /* ===== PROJECTS VIEW ===== */
      .project-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .project-card:active {
        transform: scale(0.98);
        border-color: var(--accent);
      }

      .project-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
      }

      .project-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .project-version {
        font-size: 0.7rem;
        color: var(--muted);
        background: var(--bg);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
      }

      .project-desc {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .project-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .tag {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--muted);
      }

      .tag.highlight {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--accent-soft);
      }

      /* ===== PROJECT DETAIL ===== */
      .detail-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .back-btn {
        width: 36px;
        height: 36px;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .detail-title {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .detail-section {
        margin-bottom: 1.25rem;
      }

      .detail-section-title {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .stack-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .stack-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.7rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.85rem;
      }

      .flow-diagram {
        background: var(--bg);
        border-radius: 12px;
        padding: 1rem;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8rem;
        color: var(--muted);
        overflow-x: auto;
        white-space: pre;
      }

      .command-box {
        background: var(--bg);
        border-radius: 8px;
        padding: 0.6rem 0.8rem;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8rem;
        color: var(--ok);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .command-box::before {
        content: "$";
        color: var(--muted);
      }

      /* ===== STACK VIEW ===== */
      .stack-category {
        margin-bottom: 1.25rem;
      }

      .stack-category-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .stack-tool {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 0;
        border-bottom: 1px solid var(--border);
      }

      .stack-tool:last-child {
        border-bottom: none;
      }

      .stack-tool-name {
        font-size: 0.9rem;
      }

      .stack-tool-level {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .stack-tool-level:active {
        transform: scale(0.95);
      }

      .level-dominado {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .level-funcional {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .level-basico {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .level-explorando {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      /* ===== CAPTURES VIEW ===== */
      .capture-wrapper {
        position: relative;
        overflow: hidden;
        margin-bottom: 0.6rem;
        border-radius: 12px;
      }

      .capture-delete-bg {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 80px;
        background: var(--danger);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        border-radius: 0 12px 12px 0;
      }

      .capture-item {
        position: relative;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        transition: transform 0.2s ease;
        touch-action: pan-y;
        z-index: 1;
      }

      .capture-item.swiping {
        transition: none;
      }

      .capture-item.swiped {
        transform: translateX(-80px);
      }

      .capture-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.4rem;
      }

      .capture-type {
        font-size: 0.7rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-weight: 500;
      }

      .capture-type.idea {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .capture-type.duda {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .capture-type.bug {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .capture-type.todo {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .capture-time {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .capture-text {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      /* Markdown styles */
      .capture-text code {
        background: var(--bg);
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.85em;
        color: var(--ok);
      }

      .capture-text strong {
        color: var(--text);
        font-weight: 600;
      }

      .capture-text em {
        font-style: italic;
        color: var(--muted);
      }

      .capture-text .md-list {
        display: block;
        padding-left: 0.5rem;
      }

      /* Priority indicator */
      .capture-priority {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.65rem;
        padding: 0.1rem 0.35rem;
        border-radius: 4px;
        margin-left: 0.5rem;
      }

      .capture-priority.high {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .capture-priority.medium {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .capture-priority.low {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .capture-project {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 0.35rem;
      }

      .capture-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.6rem;
        padding-top: 0.6rem;
        border-top: 1px dashed var(--border);
      }

      .capture-action {
        flex: 1;
        padding: 0.4rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--muted);
        font-size: 0.75rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s ease;
      }

      .capture-action:active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--muted);
      }

      .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      /* ===== BACKUP BUTTONS ===== */
      .backup-btn {
        flex: 1;
        padding: 0.6rem 0.8rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .backup-btn:active {
        background: var(--accent-soft);
        border-color: var(--accent);
        transform: scale(0.98);
      }

      /* API Status indicator */
      .api-status {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
      }

      .api-status.online {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .api-status.offline {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
      }

      /* ===== FILTER PILLS ===== */
      .filter-pills {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
      }

      .filter-pill {
        padding: 0.35rem 0.75rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: 0.75rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s ease;
      }

      .filter-pill.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      .filter-pill:active {
        transform: scale(0.95);
      }

      /* ===== FAB ===== */
      .fab {
        position: fixed;
        bottom: calc(4.5rem + env(safe-area-inset-bottom));
        right: 1rem;
        width: 56px;
        height: 56px;
        background: var(--accent);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        z-index: 100;
        transition: all 0.2s ease;
      }

      .fab:active {
        transform: scale(0.9);
      }

      /* ===== BOTTOM NAV ===== */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-soft);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 0;
        padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
        z-index: 1000;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.4rem 1rem;
        color: var(--muted);
        text-decoration: none;
        font-size: 0.65rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border-radius: 8px;
      }

      .nav-item.active {
        color: var(--accent);
      }

      .nav-item-icon {
        font-size: 1.3rem;
      }

      /* ===== MODAL ===== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 20px 20px 0 0;
        padding: 1.25rem;
        width: 100%;
        max-width: 500px;
        max-height: 85vh;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-handle {
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 999px;
        margin: 0 auto 1rem;
      }

      .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
      }

      .capture-types {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .capture-type-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
        padding: 0.75rem 0.5rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 12px;
        color: var(--muted);
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .capture-type-btn.selected {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent);
      }

      .capture-type-btn-icon {
        font-size: 1.3rem;
      }

      .modal textarea {
        width: 100%;
        min-height: 100px;
        padding: 0.75rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        font-size: 1rem;
        resize: none;
        outline: none;
        font-family: inherit;
      }

      .modal textarea:focus {
        border-color: var(--accent);
      }

      /* Modal Zen Mode - when keyboard is open */
      .modal.zen-mode {
        max-height: none;
        height: auto;
      }

      .modal.zen-mode .capture-types {
        display: none;
      }

      .modal.zen-mode .modal-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .modal.zen-mode textarea {
        min-height: 80px;
      }

      .modal textarea::placeholder {
        color: var(--muted);
      }

      .modal-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      .modal-btn {
        flex: 1;
        padding: 0.85rem;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s ease;
      }

      .modal-btn.secondary {
        background: var(--bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .modal-btn.primary {
        background: var(--accent);
        color: white;
      }

      .modal-btn:active {
        transform: scale(0.98);
      }

      /* Capture selectors (project + priority) */
      .capture-selectors {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.75rem;
      }

      .capture-selector {
        flex: 1;
      }

      .capture-selector label {
        display: block;
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.35rem;
      }

      .capture-selector select {
        width: 100%;
        padding: 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 0.85rem;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        padding-right: 1.5rem;
      }

      .capture-selector select:focus {
        border-color: var(--accent);
      }

      .priority-btns {
        display: flex;
        gap: 0.35rem;
      }

      .priority-btn {
        flex: 1;
        padding: 0.45rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .priority-btn.selected {
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .priority-btn:active {
        transform: scale(0.95);
      }

      /* Hide selectors in zen mode */
      .modal.zen-mode .capture-selectors {
        display: none;
      }

      /* ===== TOAST ===== */
      .toast {
        position: fixed;
        bottom: 6rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-soft);
        border: 1px solid var(--ok);
        color: var(--ok);
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        font-size: 0.85rem;
        z-index: 3000;
        opacity: 0;
        transition: all 0.3s ease;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* ===== UTILITIES ===== */
      .section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .divider {
        height: 1px;
        background: var(--border);
        margin: 1rem 0;
      }

      /* Hide scrollbar but keep functionality */
      .view::-webkit-scrollbar {
        display: none;
      }
      .view {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- ===== HEADER ===== -->
      <header class="header">
        <div class="header-top">
          <h1>‚òï minerOS</h1>
          <span class="status-pill">
            <span class="dot"></span>
            <span>Online</span>
          </span>
        </div>
        <div class="header-date" id="headerDate"></div>
      </header>

      <!-- ===== HOME VIEW ===== -->
      <div class="view active" id="viewHome">
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value ok" id="statStreak">0</div>
            <div class="stat-label">D√≠as racha</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWeek">0</div>
            <div class="stat-label">Esta semana</div>
          </div>
          <div class="stat-card">
            <div class="stat-value purple" id="statProjects">0</div>
            <div class="stat-label">Proyectos</div>
          </div>
          <div class="stat-card">
            <div class="stat-value warn" id="statCaptures">0</div>
            <div class="stat-label">Capturas</div>
          </div>
        </div>

        <!-- Session Timer -->
        <div class="session-card" id="sessionCard">
          <div class="session-label">Sesi√≥n de trabajo</div>
          <div class="session-timer" id="sessionTimer">00:00</div>
          <button class="session-btn start" id="sessionBtn" onclick="toggleSession()">
            Iniciar sesi√≥n
          </button>
        </div>

        <!-- Activity Graph -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">üìä Actividad (14 d√≠as)</span>
            <span class="card-badge" id="activityTotal">0 min</span>
          </div>
          <div class="activity-graph" id="activityGraph"></div>
        </div>

        <!-- Recent Projects -->
        <div class="section-title">üî• En progreso</div>
        <div id="recentProjects"></div>

        <!-- Recent Captures -->
        <div class="section-title" style="margin-top: 1.25rem;">üí° Capturas recientes</div>
        <div id="recentCaptures"></div>
      </div>

      <!-- ===== PROJECTS VIEW ===== -->
      <div class="view" id="viewProjects">
        <div class="section-title">üìÅ Todos los proyectos</div>
        <div class="filter-pills">
          <span class="filter-pill active" data-filter="all" onclick="setProjectFilter('all')">Todos</span>
          <span class="filter-pill" data-filter="production" onclick="setProjectFilter('production')">Production</span>
          <span class="filter-pill" data-filter="prototype" onclick="setProjectFilter('prototype')">Prototype</span>
          <span class="filter-pill" data-filter="archived" onclick="setProjectFilter('archived')">Archived</span>
        </div>
        <div id="projectsList"></div>
      </div>

      <!-- ===== PROJECT DETAIL VIEW ===== -->
      <div class="view" id="viewProjectDetail">
        <div class="detail-header">
          <button class="back-btn" onclick="showView('projects')">‚Üê</button>
          <span class="detail-title" id="detailTitle">Proyecto</span>
        </div>
        <div id="projectDetailContent"></div>
      </div>

      <!-- ===== STACK VIEW ===== -->
      <div class="view" id="viewStack">
        <div class="section-title">üõ†Ô∏è Kit de herramientas</div>
        <div id="stackContent"></div>

        <!-- DirectOS Sync Section -->
        <div class="card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <span class="card-title">üîó DirectOS API</span>
            <span class="api-status" id="apiStatus">‚ö™ Offline</span>
          </div>
          <p style="font-size: 0.8rem; color: var(--muted); margin: 0.5rem 0;">
            Sincroniza proyectos desde DirectOS si est√° corriendo en localhost:8000
          </p>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
            <button class="backup-btn" onclick="syncWithAPI()" style="flex: 1;">üîÑ Sincronizar</button>
          </div>
        </div>

        <!-- Backup Section -->
        <div class="card" style="margin-top: 1rem;">
          <div class="card-header">
            <span class="card-title">üíæ Backup de datos</span>
          </div>
          <p style="font-size: 0.8rem; color: var(--muted); margin: 0.5rem 0;">
            Exporta tus capturas y configuraci√≥n para no perderlas.
          </p>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
            <button class="backup-btn" onclick="exportData()">üì§ Exportar</button>
            <button class="backup-btn" onclick="document.getElementById('importFile').click()">üì• Importar</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
          </div>
        </div>
      </div>

      <!-- ===== CAPTURES VIEW ===== -->
      <div class="view" id="viewCaptures">
        <div class="section-title">üí° Capturas</div>
        <div id="capturesList"></div>
      </div>

      <!-- ===== FAB ===== -->
      <button class="fab" onclick="openCaptureModal()">+</button>

      <!-- ===== BOTTOM NAV ===== -->
      <nav class="bottom-nav">
        <div class="nav-item active" data-view="home" onclick="showView('home')">
          <span class="nav-item-icon">üè†</span>
          <span>Home</span>
        </div>
        <div class="nav-item" data-view="projects" onclick="showView('projects')">
          <span class="nav-item-icon">üìÅ</span>
          <span>Proyectos</span>
        </div>
        <div class="nav-item" data-view="stack" onclick="showView('stack')">
          <span class="nav-item-icon">üõ†Ô∏è</span>
          <span>Stack</span>
        </div>
        <div class="nav-item" data-view="captures" onclick="showView('captures')">
          <span class="nav-item-icon">üí°</span>
          <span>Capturas</span>
        </div>
      </nav>

      <!-- ===== CAPTURE MODAL ===== -->
      <div class="modal-overlay" id="captureModal">
        <div class="modal">
          <div class="modal-handle"></div>
          <div class="modal-title">Nueva captura</div>

          <div class="capture-types">
            <button class="capture-type-btn selected" data-type="idea" onclick="selectCaptureType('idea')">
              <span class="capture-type-btn-icon">üí°</span>
              <span>Idea</span>
            </button>
            <button class="capture-type-btn" data-type="duda" onclick="selectCaptureType('duda')">
              <span class="capture-type-btn-icon">‚ùì</span>
              <span>Duda</span>
            </button>
            <button class="capture-type-btn" data-type="bug" onclick="selectCaptureType('bug')">
              <span class="capture-type-btn-icon">üêõ</span>
              <span>Bug</span>
            </button>
            <button class="capture-type-btn" data-type="todo" onclick="selectCaptureType('todo')">
              <span class="capture-type-btn-icon">üìã</span>
              <span>TODO</span>
            </button>
          </div>

          <textarea id="captureText" placeholder="Escribe aqu√≠ tu idea, duda, bug o tarea...&#10;&#10;Soporta **negrita**, *cursiva*, `c√≥digo` y listas con -"></textarea>

          <!-- Project & Priority selectors -->
          <div class="capture-selectors">
            <div class="capture-selector">
              <label>Proyecto</label>
              <select id="captureProject">
                <option value="">Auto-detectar</option>
              </select>
            </div>
            <div class="capture-selector">
              <label>Prioridad</label>
              <div class="priority-btns">
                <button class="priority-btn low selected" data-priority="low" onclick="selectPriority('low')">üü¢</button>
                <button class="priority-btn medium" data-priority="medium" onclick="selectPriority('medium')">üü°</button>
                <button class="priority-btn high" data-priority="high" onclick="selectPriority('high')">üî¥</button>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeCaptureModal()">Cancelar</button>
            <button class="modal-btn primary" onclick="saveCapture()">Guardar</button>
          </div>
        </div>
      </div>

      <!-- ===== TOAST ===== -->
      <div class="toast" id="toast">Guardado</div>
    </div>

    <script>
      // ============================================
      // minerOS Dashboard Mobile
      // KISS: Simple, debuggeable, funcional
      // ============================================

      const STORAGE_KEY = 'mineros-dashboard-v2';

      // ===== API CONFIG =====
      const API_CONFIG = {
        baseUrl: 'http://localhost:8000',
        endpoints: {
          health: '/api/health',
          projects: '/api/projects',
          project: '/api/projects/'  // + id
        },
        timeout: 5000
      };

      let apiAvailable = false;

      // ===== DATA =====
      // Proyectos locales como fallback (si DirectOS no est√° corriendo)
      let PROJECTS = [
        {
          id: 'farmaia',
          name: 'farmaIA',
          icon: 'üíä',
          version: 'v5.0',
          status: 'production',
          description: 'Mi Botiqu√≠n Inteligente - Backend Node.js/Express + SQLite + CIMA API (25K+ medicamentos)',
          stack: ['Node.js', 'Express', 'SQLite', 'Claude API', 'SSE'],
          flow: 'User ‚Üí Frontend ‚Üí Backend ‚Üí CIMA API ‚Üí Claude ‚Üí SSE ‚Üí User',
          commands: ['node backend/server.js', 'open frontend/index.html'],
          repo: '~/Desktop/farmaia',
          lastActivity: 0
        },
        {
          id: 'photomine',
          name: 'PhotoMine',
          icon: 'üì∏',
          version: 'v1.4',
          status: 'production',
          description: 'Organizaci√≥n de fotos para localizadores con IA (CLIP) + Dashboard Web + Validaci√≥n Interactiva',
          stack: ['Python', 'CLIP', 'SQLite', 'Flask', 'OpenCV'],
          flow: 'Fotos ‚Üí EXIF ‚Üí CLIP Analysis ‚Üí SQLite ‚Üí Dashboard',
          commands: ['python main.py --input ~/Fotos', 'python web_app.py'],
          repo: '~/Desktop/photomine',
          lastActivity: 1
        },
        {
          id: 'directos',
          name: 'DirectOS',
          icon: 'üß†',
          version: 'v8.0',
          status: 'production',
          description: 'Sistema operativo personal de conocimiento. Dashboard para herramientas, patterns, flows y proyectos',
          stack: ['FastAPI', 'Python', 'HTMX', 'Markdown', 'SQLite'],
          flow: 'Markdown ‚Üí ContentManager ‚Üí FastAPI ‚Üí JSON API',
          commands: ['./start.sh', 'uvicorn main:app --reload'],
          repo: '~/Desktop/DirectOS',
          lastActivity: 0
        },
        {
          id: 'docmine',
          name: 'DocMine',
          icon: 'üìÑ',
          version: 'v0.3.0',
          status: 'archived',
          description: 'Organizador de documentos legales con clasificaci√≥n autom√°tica y dashboard web. Metodolog√≠a ORO-GEMAS-TESORO',
          stack: ['Python', 'Flask', 'SQLite', 'spaCy', 'BeautifulSoup'],
          flow: 'Docs ‚Üí Scanner ‚Üí GemaEngine ‚Üí Vault ‚Üí Dashboard',
          commands: ['python main.py scan /ruta', 'python main.py web'],
          repo: '~/Desktop/Mineria de BD/DocMine-OLD',
          lastActivity: 10
        },
        {
          id: 'docmine-fiscal',
          name: 'DocMine Fiscal',
          icon: 'üßæ',
          version: 'v1.0',
          status: 'production',
          description: 'Procesamiento autom√°tico de Modelo 130 con OCR + regex. 93K‚Ç¨ procesados con 100% √©xito',
          stack: ['Python', 'OCR', 'Flask', 'SQLite', 'Tesseract'],
          flow: 'PDFs ‚Üí OCR ‚Üí Regex Parser ‚Üí SQLite ‚Üí Dashboard',
          commands: ['python main.py procesar --input ~/Fiscal/', 'python main.py dashboard'],
          repo: '~/Desktop/docmine-fiscal',
          lastActivity: 5
        },
        {
          id: 'web-scraper-ia',
          name: 'Web Scraper IA',
          icon: 'üï∑Ô∏è',
          version: 'v1.0',
          status: 'production',
          description: 'Web scraping inteligente con Claude para datos estructurados seg√∫n schemas Pydantic',
          stack: ['Python', 'Claude', 'Pydantic', 'HTTPX', 'BeautifulSoup'],
          flow: 'URL ‚Üí HTTPX ‚Üí BeautifulSoup ‚Üí Claude ‚Üí Pydantic ‚Üí SQLite',
          commands: ['python main.py scrape URL -s product', 'python main.py stats'],
          repo: '~/Desktop/obtener datos de web',
          lastActivity: 2
        },
        {
          id: 'simulaciones-maz',
          name: 'Simulaciones MAZ',
          icon: 'üìà',
          version: 'v1.0',
          status: 'production',
          description: 'Simulaci√≥n financiera Monte Carlo para proyecciones presupuestarias. 3 m√≥dulos de an√°lisis',
          stack: ['HTML', 'JavaScript', 'Chart.js', 'Monte Carlo'],
          flow: 'Datos ‚Üí Monte Carlo (10K iter) ‚Üí Chart.js ‚Üí Reportes',
          commands: ['open "Dashboard Financiero MAZ.html"', 'python -m http.server 8080'],
          repo: '~/Desktop/Simulaciones',
          lastActivity: 3
        },
        {
          id: 'mineros2',
          name: 'minerOS v2 Backend',
          icon: '‚õèÔ∏è',
          version: 'v0.1.0',
          status: 'prototype',
          description: 'Backend API scaffold con FastAPI + ChromaDB persistente. Arquitectura ORO-GEMAS-TESORO',
          stack: ['FastAPI', 'ChromaDB', 'Python', 'Pydantic', 'Uvicorn'],
          flow: 'Files ‚Üí Ingest API ‚Üí ChromaDB ‚Üí Semantic Search',
          commands: ['uvicorn app.main:app --reload', 'curl http://localhost:8000/health'],
          repo: '~/Desktop/MinerOs2',
          lastActivity: 7
        },
        {
          id: 'portfolio-dibujo',
          name: 'Portfolio Dibujo',
          icon: 'üé®',
          version: 'v1.0',
          status: 'prototype',
          description: 'Portfolio web est√°tico para artista digital. Galer√≠a responsive generada desde markdown',
          stack: ['HTML', 'CSS', 'Alpine.js', 'Markdown', 'Python'],
          flow: 'projects/*.md ‚Üí Python Generator ‚Üí Static HTML',
          commands: ['python main.py build', 'python main.py serve'],
          repo: '~/Desktop/portfolio-dibujo',
          lastActivity: 8
        },
        {
          id: 'limpiador-pdfs',
          name: 'Limpiador PDFs',
          icon: 'üßπ',
          version: 'v1.0',
          status: 'archived',
          description: 'Herramienta GUI para limpieza batch de PDFs: metadata, compresi√≥n, extracci√≥n de p√°ginas',
          stack: ['Python', 'tkinter', 'PyMuPDF', 'PyPDF'],
          flow: 'PDFs ‚Üí GUI tkinter ‚Üí Operaciones ‚Üí Output',
          commands: ['python limpiador_pdfs.py'],
          repo: '~',
          lastActivity: 15
        },
        {
          id: 'dashboard-seguimiento',
          name: 'Dashboard Mobile',
          icon: 'üì±',
          version: 'v2.0',
          status: 'production',
          description: 'Este dashboard m√≥vil minerOS para consulta r√°pida de proyectos y capturas',
          stack: ['HTML5', 'CSS3', 'JavaScript', 'LocalStorage'],
          flow: 'User ‚Üí Dashboard ‚Üí LocalStorage',
          commands: ['python -m http.server 8080', 'open index.html'],
          repo: '~/Desktop/dashboard-seguimiento',
          lastActivity: 0
        }
      ];

      // ===== API FUNCTIONS =====
      async function checkApiHealth() {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), API_CONFIG.timeout);

          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.health, {
            signal: controller.signal
          });
          clearTimeout(timeout);

          if (response.ok) {
            const data = await response.json();
            apiAvailable = true;
            console.log('[API] DirectOS conectado:', data.version);
            return data;
          }
        } catch (e) {
          apiAvailable = false;
          console.log('[API] DirectOS no disponible, usando datos locales');
        }
        return null;
      }

      async function fetchProjectsFromAPI() {
        if (!apiAvailable) return null;

        try {
          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.projects);
          if (response.ok) {
            const data = await response.json();
            // Transformar formato API a formato local
            return data.projects.map(p => ({
              id: p.id,
              name: p.name,
              icon: getProjectIcon(p.id, p.stack),
              version: p.version || 'v1.0',
              status: p.status || 'production',
              description: p.description || '',
              stack: p.stack || [],
              flow: p.flow || '',
              commands: p.commands || [],
              repo: p.repo || '',
              lastActivity: 0
            }));
          }
        } catch (e) {
          console.log('[API] Error fetching projects:', e);
        }
        return null;
      }

      function getProjectIcon(id, stack) {
        // Mapeo de iconos por proyecto o stack
        const iconMap = {
          'farmaia': 'üíä',
          'photomine': 'üì∏',
          'directos': 'üß†',
          'docmine': 'üìÑ',
          'docmine-fiscal': 'üßæ',
          'web-scraper-ia': 'üï∑Ô∏è',
          'simulaciones-maz': 'üìà',
          'mineros2': '‚õèÔ∏è',
          'portfolio-dibujo': 'üé®',
          'limpiador-pdfs': 'üßπ',
          'dashboard-seguimiento': 'üì±',
          'dashboard-mobile-mineros': 'üì±'
        };

        if (iconMap[id]) return iconMap[id];

        // Fallback por stack
        if (stack?.includes('python') || stack?.includes('flask') || stack?.includes('fastapi')) return 'üêç';
        if (stack?.includes('node') || stack?.includes('express')) return 'üì¶';
        if (stack?.includes('html') || stack?.includes('javascript')) return 'üåê';
        return 'üìÅ';
      }

      async function syncWithAPI() {
        updateApiStatus('checking');
        const health = await checkApiHealth();

        if (health) {
          updateApiStatus('online');
          const apiProjects = await fetchProjectsFromAPI();
          if (apiProjects && apiProjects.length > 0) {
            PROJECTS = apiProjects;
            console.log('[API] Proyectos cargados desde DirectOS:', PROJECTS.length);
            renderHome();
            renderProjects();
            populateProjectDropdown();
            showToast(`Sincronizado: ${PROJECTS.length} proyectos`);
          }
        } else {
          updateApiStatus('offline');
        }
      }

      function updateApiStatus(status) {
        const el = document.getElementById('apiStatus');
        if (!el) return;

        switch (status) {
          case 'online':
            el.textContent = 'üü¢ Online';
            el.className = 'api-status online';
            break;
          case 'checking':
            el.textContent = 'üîÑ Conectando...';
            el.className = 'api-status';
            break;
          default:
            el.textContent = '‚ö™ Offline';
            el.className = 'api-status offline';
        }
      }

      const STACK = {
        python: {
          title: 'üêç Python',
          tools: [
            { name: 'Flask', level: 'dominado' },
            { name: 'FastAPI', level: 'dominado' },
            { name: 'SQLite', level: 'dominado' },
            { name: 'Pydantic', level: 'funcional' },
            { name: 'BeautifulSoup', level: 'funcional' },
            { name: 'HTTPX', level: 'funcional' }
          ]
        },
        web: {
          title: 'üåê Web',
          tools: [
            { name: 'HTML5', level: 'dominado' },
            { name: 'CSS3 / Grid / Flexbox', level: 'dominado' },
            { name: 'JavaScript ES6+', level: 'dominado' },
            { name: 'HTMX', level: 'funcional' },
            { name: 'Alpine.js', level: 'funcional' },
            { name: 'Chart.js', level: 'funcional' }
          ]
        },
        ia: {
          title: 'ü§ñ IA / ML',
          tools: [
            { name: 'Claude API', level: 'dominado' },
            { name: 'CLIP (OpenAI)', level: 'dominado' },
            { name: 'OCR (Tesseract)', level: 'funcional' },
            { name: 'ChromaDB', level: 'basico' },
            { name: 'Embeddings', level: 'basico' },
            { name: 'spaCy', level: 'explorando' }
          ]
        },
        node: {
          title: 'üì¶ Node.js',
          tools: [
            { name: 'Express.js', level: 'funcional' },
            { name: 'SSE (Server-Sent Events)', level: 'funcional' },
            { name: 'npm', level: 'funcional' }
          ]
        },
        tools: {
          title: '‚öôÔ∏è Herramientas',
          tools: [
            { name: 'Claude Code', level: 'dominado' },
            { name: 'VS Code', level: 'dominado' },
            { name: 'Git', level: 'funcional' },
            { name: 'Terminal / Bash', level: 'funcional' },
            { name: 'Markdown', level: 'dominado' }
          ]
        }
      };

      // ===== STATE =====
      let state = {
        currentView: 'home',
        currentProject: null,
        captureType: 'idea',
        capturePriority: 'low', // low, medium, high
        captures: [],
        activityLog: {}, // { "2024-11-25": { sessions: 2, minutes: 75 }, ... }
        stackLevels: {},
        projectFilter: 'all', // all, production, prototype, archived
        // Session tracking
        sessionActive: false,
        sessionStart: null
      };

      let sessionTimer = null; // Interval for updating timer display

      // ===== SECURITY: Escape HTML to prevent XSS =====
      function escapeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // ===== INIT =====
      function init() {
        loadState();
        updateHeaderDate();
        renderHome();
        renderProjects();
        renderStack();
        renderCaptures();

        // Restore active session timer if it was running
        if (state.sessionActive && state.sessionStart) {
          sessionTimer = setInterval(updateSessionUI, 1000);
        }
        updateSessionUI();

        // Update date every minute
        setInterval(updateHeaderDate, 60000);

        // Try to sync with DirectOS API (non-blocking)
        syncWithAPI();
      }

      // ===== STORAGE =====
      function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          state.captures = data.captures || [];
          state.stackLevels = data.stackLevels || {};
          state.activityLog = data.activityLog || {};

          // Restore active session if browser was closed
          if (data.sessionActive && data.sessionStart) {
            state.sessionActive = true;
            state.sessionStart = data.sessionStart;
          }
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          captures: state.captures,
          stackLevels: state.stackLevels,
          activityLog: state.activityLog,
          sessionActive: state.sessionActive,
          sessionStart: state.sessionStart
        }));
        showToast('Guardado');
      }

      function saveStateSilent() {
        // Save without toast (for timer updates)
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          captures: state.captures,
          stackLevels: state.stackLevels,
          activityLog: state.activityLog,
          sessionActive: state.sessionActive,
          sessionStart: state.sessionStart
        }));
      }

      // ===== NAVIGATION =====
      function showView(viewName) {
        haptic(5); // Light feedback on nav

        // Hide all views
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

        // Show target view
        const targetView = document.getElementById('view' + capitalize(viewName));
        if (targetView) {
          targetView.classList.add('active');
        }

        // Update nav
        document.querySelectorAll('.nav-item').forEach(n => {
          n.classList.toggle('active', n.dataset.view === viewName);
        });

        state.currentView = viewName;

        // Scroll to top
        targetView?.scrollTo(0, 0);
      }

      function showProjectDetail(projectId) {
        const project = PROJECTS.find(p => p.id === projectId);
        if (!project) return;

        state.currentProject = project;
        document.getElementById('detailTitle').textContent = project.icon + ' ' + project.name;

        const content = document.getElementById('projectDetailContent');
        content.innerHTML = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <span class="project-status ${project.status}">${project.status}</span>
              <span class="project-version">${project.version}</span>
            </div>
            <p style="color: var(--muted); font-size: 0.9rem; margin: 0;">${project.description}</p>
            ${project.repo ? `<div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; font-family: monospace;">üìÇ ${project.repo}</div>` : ''}
          </div>

          <div class="detail-section">
            <div class="detail-section-title">üõ†Ô∏è Stack</div>
            <div class="stack-list">
              ${project.stack.map(s => `<div class="stack-item">${s}</div>`).join('')}
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">üîÑ Flujo</div>
            <div class="flow-diagram">${project.flow}</div>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">‚å®Ô∏è Comandos</div>
            ${project.commands.map(c => `<div class="command-box">${c}</div>`).join('')}
          </div>
        `;

        // Hide nav items active state and show detail view
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('viewProjectDetail').classList.add('active');
      }

      // ===== RENDER FUNCTIONS =====
      function updateHeaderDate() {
        const now = new Date();
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('headerDate').textContent = now.toLocaleDateString('es-ES', options);
      }

      function renderHome() {
        // Stats - using real activity data
        const streak = calculateStreak();
        const weekMinutes = getWeekMinutes();
        const pendingCaptures = state.captures.filter(c => !c.processed).length;

        document.getElementById('statStreak').textContent = streak;
        document.getElementById('statWeek').textContent = weekMinutes + 'min';
        document.getElementById('statProjects').textContent = PROJECTS.length;
        document.getElementById('statCaptures').textContent = pendingCaptures;

        // Activity graph - real data from last 14 days
        const graphEl = document.getElementById('activityGraph');
        const activityData = getLast14DaysActivity();
        const maxActivity = Math.max(...activityData, 1);
        graphEl.innerHTML = activityData.map((val, i) => {
          const height = Math.max(4, (val / maxActivity) * 50);
          const isToday = i === activityData.length - 1;
          const isActive = val > 0;
          return `<div class="activity-bar ${isActive ? 'active' : ''} ${isToday ? 'today' : ''}" style="height: ${height}px"></div>`;
        }).join('');

        const totalMinutes = activityData.reduce((a, b) => a + b, 0);
        document.getElementById('activityTotal').textContent = totalMinutes + ' min';

        // Recent projects (sorted by lastActivity)
        const recentProjects = [...PROJECTS]
          .sort((a, b) => a.lastActivity - b.lastActivity)
          .slice(0, 3);

        document.getElementById('recentProjects').innerHTML = recentProjects.map(p => `
          <div class="project-mini" onclick="showProjectDetail('${p.id}')">
            <div class="project-icon">${p.icon}</div>
            <div class="project-info">
              <div class="project-name">${p.name}</div>
              <div class="project-meta">${p.stack.slice(0, 2).join(' ¬∑ ')}</div>
            </div>
            <span class="project-status ${p.status}">${p.status}</span>
          </div>
        `).join('');

        // Recent captures
        const recentCaptures = state.captures
          .filter(c => !c.processed)
          .slice(0, 2);

        if (recentCaptures.length === 0) {
          document.getElementById('recentCaptures').innerHTML = `
            <div style="text-align: center; padding: 1rem; color: var(--muted); font-size: 0.85rem;">
              Sin capturas pendientes
            </div>
          `;
        } else {
          document.getElementById('recentCaptures').innerHTML = recentCaptures.map(c => `
            <div class="capture-item">
              <div class="capture-header">
                <span>
                  <span class="capture-type ${c.type}">${getTypeEmoji(c.type)} ${c.type}</span>
                  ${c.priority && c.priority !== 'low' ? `<span class="capture-priority ${c.priority}">${getPriorityEmoji(c.priority)}</span>` : ''}
                </span>
                <span class="capture-time">${formatTime(c.timestamp)}</span>
              </div>
              <div class="capture-text">${renderMarkdown(c.text)}</div>
            </div>
          `).join('');
        }
      }

      function renderProjects() {
        // Filter projects based on state.projectFilter
        let filtered = PROJECTS;
        if (state.projectFilter !== 'all') {
          filtered = PROJECTS.filter(p => p.status === state.projectFilter);
        }

        if (filtered.length === 0) {
          document.getElementById('projectsList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÅ</div>
              <p>No hay proyectos con estado "${state.projectFilter}"</p>
            </div>
          `;
          return;
        }

        document.getElementById('projectsList').innerHTML = filtered.map(p => `
          <div class="project-card" onclick="showProjectDetail('${p.id}')">
            <div class="project-card-header">
              <span class="project-card-title">${p.icon} ${p.name}</span>
              <span class="project-status ${p.status}">${p.status}</span>
            </div>
            <div class="project-desc">${escapeHTML(p.description)}</div>
            <div class="project-tags">
              ${p.stack.slice(0, 3).map(s => `<span class="tag">${escapeHTML(s)}</span>`).join('')}
              <span class="tag highlight">${p.version}</span>
            </div>
          </div>
        `).join('');
      }

      function renderStack() {
        let html = '';

        for (const [category, data] of Object.entries(STACK)) {
          html += `
            <div class="stack-category">
              <div class="stack-category-title">${data.title}</div>
              ${data.tools.map(tool => {
                const level = state.stackLevels[tool.name] || tool.level;
                return `
                  <div class="stack-tool">
                    <span class="stack-tool-name">${tool.name}</span>
                    <span class="stack-tool-level level-${level}" onclick="cycleLevel('${tool.name}')">${level}</span>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }

        document.getElementById('stackContent').innerHTML = html;
      }

      function renderCaptures() {
        const captures = state.captures.filter(c => !c.processed);

        if (captures.length === 0) {
          document.getElementById('capturesList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üí°</div>
              <p>Sin capturas pendientes</p>
              <p style="font-size: 0.8rem;">Usa el bot√≥n + para a√±adir ideas, dudas o bugs</p>
            </div>
          `;
          return;
        }

        document.getElementById('capturesList').innerHTML = captures.map((c, i) => `
          <div class="capture-wrapper">
            <div class="capture-delete-bg" onclick="deleteCapture(${i})">üóëÔ∏è</div>
            <div class="capture-item" data-index="${i}">
              <div class="capture-header">
                <span>
                  <span class="capture-type ${c.type}">${getTypeEmoji(c.type)} ${c.type}</span>
                  ${c.priority && c.priority !== 'low' ? `<span class="capture-priority ${c.priority}">${getPriorityEmoji(c.priority)}</span>` : ''}
                </span>
                <span class="capture-time">${formatTime(c.timestamp)}</span>
              </div>
              <div class="capture-text">${renderMarkdown(c.text)}</div>
              ${c.project ? `<div class="capture-project">üìÅ ${escapeHTML(c.project)}</div>` : ''}
              <div class="capture-actions">
                <button class="capture-action" onclick="processCapture(${i}, 'done')">‚úì Hecho</button>
                <button class="capture-action" onclick="processCapture(${i}, 'later')">‚è∞ Luego</button>
                <button class="capture-action" onclick="deleteCapture(${i})">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');

        // Initialize swipe handlers
        initSwipeHandlers();
      }

      // ===== CAPTURES =====
      function openCaptureModal() {
        document.getElementById('captureModal').classList.add('show');
        const textarea = document.getElementById('captureText');
        textarea.focus();

        // Populate project dropdown
        populateProjectDropdown();

        // Setup Zen mode for virtual keyboard
        setupZenMode();
      }

      function closeCaptureModal() {
        document.getElementById('captureModal').classList.remove('show');
        document.getElementById('captureText').value = '';
        document.getElementById('captureProject').value = '';
        selectCaptureType('idea');
        selectPriority('low');

        // Remove Zen mode
        const modal = document.querySelector('#captureModal .modal');
        modal.classList.remove('zen-mode');
      }

      function populateProjectDropdown() {
        const select = document.getElementById('captureProject');
        // Keep first option (Auto-detectar)
        select.innerHTML = '<option value="">Auto-detectar</option>';
        // Add all projects
        PROJECTS.forEach(p => {
          select.innerHTML += `<option value="${p.name}">${p.icon} ${p.name}</option>`;
        });
      }

      function selectPriority(priority) {
        state.capturePriority = priority;
        document.querySelectorAll('.priority-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.priority === priority);
        });
      }

      // Zen Mode: Adjust modal when virtual keyboard appears
      function setupZenMode() {
        const modal = document.querySelector('#captureModal .modal');
        const textarea = document.getElementById('captureText');

        // Use visualViewport API if available
        if (window.visualViewport) {
          const handleResize = () => {
            const viewportHeight = window.visualViewport.height;
            const windowHeight = window.innerHeight;

            // If viewport is significantly smaller, keyboard is likely open
            if (viewportHeight < windowHeight * 0.75) {
              modal.classList.add('zen-mode');
              // Scroll textarea into view
              setTimeout(() => textarea.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            } else {
              modal.classList.remove('zen-mode');
            }
          };

          window.visualViewport.addEventListener('resize', handleResize);

          // Cleanup on modal close
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (!document.getElementById('captureModal').classList.contains('show')) {
                window.visualViewport.removeEventListener('resize', handleResize);
                observer.disconnect();
              }
            });
          });
          observer.observe(document.getElementById('captureModal'), { attributes: true });
        }

        // Fallback: detect focus on textarea
        textarea.addEventListener('focus', () => {
          setTimeout(() => {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }

      function selectCaptureType(type) {
        state.captureType = type;
        document.querySelectorAll('.capture-type-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.type === type);
        });
      }

      function saveCapture() {
        const text = document.getElementById('captureText').value.trim();
        if (!text) return;

        // Get selected project or auto-detect
        const selectedProject = document.getElementById('captureProject').value;
        const project = selectedProject || detectProject(text);

        const capture = {
          id: 'cap_' + Date.now(),
          type: state.captureType,
          text: text,
          project: project,
          priority: state.capturePriority,
          timestamp: new Date().toISOString(),
          processed: false
        };

        state.captures.unshift(capture);
        haptic(15); // Feedback on save
        saveState();
        closeCaptureModal();
        renderHome();
        renderCaptures();
      }

      function processCapture(index, action) {
        haptic();
        if (action === 'done') {
          state.captures[index].processed = true;
        }
        saveState();
        renderHome();
        renderCaptures();
      }

      function deleteCapture(index) {
        haptic();
        state.captures.splice(index, 1);
        saveState();
        renderHome();
        renderCaptures();
      }

      // ===== SWIPE TO DELETE =====
      function initSwipeHandlers() {
        const items = document.querySelectorAll('.capture-item[data-index]');

        items.forEach(item => {
          let startX = 0;
          let currentX = 0;
          let isDragging = false;

          item.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
            item.classList.add('swiping');
            item.classList.remove('swiped');
          }, { passive: true });

          item.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = startX - currentX;

            // Only allow left swipe (positive diff)
            if (diff > 0) {
              const translateX = Math.min(diff, 80);
              item.style.transform = `translateX(-${translateX}px)`;
            }
          }, { passive: true });

          item.addEventListener('touchend', () => {
            isDragging = false;
            item.classList.remove('swiping');

            const diff = startX - currentX;

            if (diff > 50) {
              // Swipe threshold reached - show delete button
              item.classList.add('swiped');
              item.style.transform = '';
              haptic();
            } else {
              // Reset position
              item.style.transform = '';
              item.classList.remove('swiped');
            }
          });

          // Click anywhere on item to reset swipe
          item.addEventListener('click', (e) => {
            if (item.classList.contains('swiped')) {
              e.stopPropagation();
              item.classList.remove('swiped');
            }
          });
        });
      }

      // ===== HAPTIC FEEDBACK =====
      function haptic(duration = 10) {
        if (navigator.vibrate) {
          navigator.vibrate(duration);
        }
      }

      // ===== MARKDOWN B√ÅSICO =====
      // Aplicar DESPU√âS de escapeHTML para seguridad
      function renderMarkdown(text) {
        if (!text) return '';

        // First escape HTML for security
        let safe = escapeHTML(text);

        // Then apply markdown transformations
        safe = safe
          // Bold: **text** or __text__
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.+?)__/g, '<strong>$1</strong>')
          // Italic: *text* or _text_
          .replace(/\*([^*]+)\*/g, '<em>$1</em>')
          .replace(/_([^_]+)_/g, '<em>$1</em>')
          // Code: `code`
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          // Lists: - item (at start of line)
          .replace(/^- (.+)$/gm, '<span class="md-list">‚Ä¢ $1</span>')
          // Line breaks
          .replace(/\n/g, '<br>');

        return safe;
      }

      function detectProject(text) {
        const keywords = {
          'farmaIA': ['farmacia', 'medicamento', 'cima', 'botiquin', 'farmaia', 'irpf'],
          'PhotoMine': ['foto', 'clip', 'imagen', 'localizador', 'photomine', 'exif', 'galeria'],
          'DocMine': ['documento', 'docmine', 'legal', 'clasificacion'],
          'DocMine Fiscal': ['fiscal', 'modelo 130', '130', 'hacienda', 'aeat'],
          'DirectOS': ['directos', 'knowledge', 'markdown', 'pattern', 'flow'],
          'Web Scraper IA': ['scraper', 'scraping', 'web', 'pydantic', 'schema'],
          'Simulaciones MAZ': ['simulacion', 'montecarlo', 'presupuesto', 'financiero', 'maz'],
          'minerOS v2': ['mineros', 'chromadb', 'vector', 'embedding'],
          'Portfolio Dibujo': ['portfolio', 'dibujo', 'arte', 'galeria'],
          'Dashboard Mobile': ['dashboard', 'mobile', 'seguimiento']
        };

        const lowerText = text.toLowerCase();
        for (const [project, words] of Object.entries(keywords)) {
          if (words.some(word => lowerText.includes(word))) {
            return project;
          }
        }
        return null;
      }

      // ===== STACK =====
      function cycleLevel(toolName) {
        const levels = ['explorando', 'basico', 'funcional', 'dominado'];
        const currentLevel = state.stackLevels[toolName] ||
          Object.values(STACK).flatMap(c => c.tools).find(t => t.name === toolName)?.level || 'explorando';

        const currentIndex = levels.indexOf(currentLevel);
        const nextIndex = (currentIndex + 1) % levels.length;
        state.stackLevels[toolName] = levels[nextIndex];

        saveState();
        renderStack();
      }

      // ===== HELPERS =====
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function getTypeEmoji(type) {
        const emojis = { idea: 'üí°', duda: '‚ùì', bug: 'üêõ', todo: 'üìã' };
        return emojis[type] || 'üí°';
      }

      function getPriorityEmoji(priority) {
        const emojis = { high: 'üî¥ Alta', medium: 'üü° Media', low: 'üü¢ Baja' };
        return emojis[priority] || '';
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'ahora';
        if (diffMins < 60) return diffMins + 'min';
        if (diffHours < 24) return diffHours + 'h';
        if (diffDays < 7) return diffDays + 'd';
        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
      }

      // ===== SESSION TIMER =====
      function getTodayKey() {
        return new Date().toISOString().split('T')[0];
      }

      function toggleSession() {
        if (state.sessionActive) {
          stopSession();
        } else {
          startSession();
        }
      }

      function startSession() {
        state.sessionActive = true;
        state.sessionStart = Date.now();
        saveStateSilent();

        updateSessionUI();
        sessionTimer = setInterval(updateSessionUI, 1000);
        showToast('Sesi√≥n iniciada');
      }

      function stopSession() {
        if (!state.sessionStart) return;

        // Calculate duration
        const durationMs = Date.now() - state.sessionStart;
        const durationMin = Math.round(durationMs / 60000);

        // Save to activity log
        const today = getTodayKey();
        if (!state.activityLog[today]) {
          state.activityLog[today] = { sessions: 0, minutes: 0 };
        }
        state.activityLog[today].sessions++;
        state.activityLog[today].minutes += durationMin;

        // Reset session
        state.sessionActive = false;
        state.sessionStart = null;
        clearInterval(sessionTimer);
        sessionTimer = null;

        saveState();
        updateSessionUI();
        renderHome();
        showToast(`Sesi√≥n guardada: ${durationMin} min`);
      }

      function updateSessionUI() {
        const card = document.getElementById('sessionCard');
        const timer = document.getElementById('sessionTimer');
        const btn = document.getElementById('sessionBtn');

        if (state.sessionActive && state.sessionStart) {
          const elapsed = Date.now() - state.sessionStart;
          const mins = Math.floor(elapsed / 60000);
          const secs = Math.floor((elapsed % 60000) / 1000);
          timer.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

          card.classList.add('active');
          btn.textContent = 'Detener sesi√≥n';
          btn.classList.remove('start');
          btn.classList.add('stop');
        } else {
          timer.textContent = '00:00';
          card.classList.remove('active');
          btn.textContent = 'Iniciar sesi√≥n';
          btn.classList.remove('stop');
          btn.classList.add('start');
        }
      }

      function getLast14DaysActivity() {
        const result = [];
        const today = new Date();

        for (let i = 13; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const key = date.toISOString().split('T')[0];
          const dayData = state.activityLog[key] || { sessions: 0, minutes: 0 };
          result.push(dayData.minutes);
        }
        return result;
      }

      function calculateStreak() {
        let streak = 0;
        const today = new Date();

        for (let i = 0; i < 365; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const key = date.toISOString().split('T')[0];
          const dayData = state.activityLog[key];

          if (dayData && dayData.minutes > 0) {
            streak++;
          } else if (i > 0) {
            // Allow today to not have activity yet
            break;
          }
        }
        return streak;
      }

      function getWeekMinutes() {
        let total = 0;
        const today = new Date();

        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const key = date.toISOString().split('T')[0];
          const dayData = state.activityLog[key];
          if (dayData) {
            total += dayData.minutes;
          }
        }
        return total;
      }

      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      }

      // ===== BACKUP: EXPORT/IMPORT =====
      function exportData() {
        const data = {
          version: '2.1',
          exportDate: new Date().toISOString(),
          captures: state.captures,
          stackLevels: state.stackLevels,
          activityLog: state.activityLog
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mineros-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup exportado');
      }

      function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Validar estructura
            if (!data.captures && !data.stackLevels && !data.activityLog) {
              throw new Error('Formato inv√°lido');
            }

            // Merge con datos actuales
            if (data.captures) {
              // A√±adir capturas que no existan (por id)
              const existingIds = new Set(state.captures.map(c => c.id));
              const newCaptures = data.captures.filter(c => !existingIds.has(c.id));
              state.captures = [...state.captures, ...newCaptures];
            }

            if (data.stackLevels) {
              state.stackLevels = { ...state.stackLevels, ...data.stackLevels };
            }

            if (data.activityLog) {
              // Merge activity logs, keeping higher values
              for (const [date, dayData] of Object.entries(data.activityLog)) {
                if (!state.activityLog[date]) {
                  state.activityLog[date] = dayData;
                } else {
                  state.activityLog[date].sessions = Math.max(
                    state.activityLog[date].sessions,
                    dayData.sessions
                  );
                  state.activityLog[date].minutes = Math.max(
                    state.activityLog[date].minutes,
                    dayData.minutes
                  );
                }
              }
            }

            saveState();
            renderHome();
            renderStack();
            renderCaptures();
            showToast(`Importado: ${data.captures?.length || 0} capturas`);
          } catch (err) {
            showToast('Error: archivo inv√°lido');
            console.error('Import error:', err);
          }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset input
      }

      // ===== PROJECT FILTERS =====
      function setProjectFilter(filter) {
        state.projectFilter = filter;
        renderProjects();

        // Update active pill
        document.querySelectorAll('.filter-pill').forEach(pill => {
          pill.classList.toggle('active', pill.dataset.filter === filter);
        });
      }

      // Click outside modal to close
      document.getElementById('captureModal').addEventListener('click', (e) => {
        if (e.target.id === 'captureModal') {
          closeCaptureModal();
        }
      });

      // ===== START =====
      document.addEventListener('DOMContentLoaded', init);

      // ===== PWA: Register Service Worker =====
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then((registration) => {
              console.log('[PWA] Service Worker registered:', registration.scope);

              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New version available
                    if (confirm('Nueva versi√≥n disponible. ¬øActualizar?')) {
                      newWorker.postMessage('skipWaiting');
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((error) => {
              console.log('[PWA] Service Worker registration failed:', error);
            });
        });
      }

      // ===== PWA: Install prompt =====
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Could show a custom install button here
        console.log('[PWA] Install prompt available');
      });
    </script>
  </body>
</html>
