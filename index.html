<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>minerOS Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="description" content="Dashboard m√≥vil minerOS para consulta r√°pida de proyectos y capturas" />

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0f172a" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="minerOS" />

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json" />

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icons/icon.svg" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png" />

    <style>
      :root {
        --bg: #0f172a;
        --bg-soft: #1e293b;
        --card: #0f172a;
        --border: #334155;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.15);
        --text: #f1f5f9;
        --muted: #94a3b8;
        --danger: #ef4444;
        --warn: #f59e0b;
        --ok: #22c55e;
        --purple: #a855f7;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 15px;
        line-height: 1.5;
        min-height: 100vh;
        min-height: 100dvh;
        overflow-x: hidden;
      }

      /* ===== APP CONTAINER ===== */
      .app {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        min-height: 100dvh;
      }

      .view {
        display: none;
        flex: 1;
        padding: 1rem;
        padding-bottom: 5rem;
        overflow-y: auto;
      }

      .view.active {
        display: block;
      }

      /* ===== HEADER ===== */
      .header {
        padding: 1rem;
        padding-top: max(1rem, env(safe-area-inset-top));
        background: linear-gradient(180deg, var(--bg-soft) 0%, var(--bg) 100%);
        border-bottom: 1px solid var(--border);
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 1.4rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .header-date {
        font-size: 0.8rem;
        color: var(--muted);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.65rem;
        background: var(--accent-soft);
        border: 1px solid var(--accent);
        border-radius: 999px;
        font-size: 0.75rem;
        color: var(--accent);
      }

      .status-pill .dot {
        width: 6px;
        height: 6px;
        background: var(--accent);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* ===== SEARCH BAR ===== */
      .search-bar {
        margin-top: 0.75rem;
        position: relative;
      }

      .search-input {
        width: 100%;
        padding: 0.6rem 0.75rem 0.6rem 2.25rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 0.9rem;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .search-input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-soft);
      }

      .search-input::placeholder {
        color: var(--muted);
      }

      .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
        font-size: 0.9rem;
        pointer-events: none;
      }

      .search-clear {
        position: absolute;
        right: 0.5rem;
        top: 50%;
        transform: translateY(-50%);
        background: var(--bg-soft);
        border: none;
        color: var(--muted);
        font-size: 1rem;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        border-radius: 6px;
        display: none;
      }

      .search-clear.visible {
        display: block;
      }

      /* Search Results */
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        margin-top: 0.5rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        max-height: 60vh;
        overflow-y: auto;
        z-index: 100;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        display: none;
      }

      .search-results.active {
        display: block;
      }

      .search-section {
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border);
      }

      .search-section:last-child {
        border-bottom: none;
      }

      .search-section-title {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding: 0.25rem 0.75rem;
      }

      .search-result-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.75rem;
        cursor: pointer;
        transition: background 0.15s;
      }

      .search-result-item:hover,
      .search-result-item:active {
        background: var(--bg);
      }

      .search-result-icon {
        font-size: 1.1rem;
        width: 1.5rem;
        text-align: center;
      }

      .search-result-info {
        flex: 1;
        min-width: 0;
      }

      .search-result-name {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .search-result-meta {
        font-size: 0.75rem;
        color: var(--muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .search-highlight {
        background: var(--accent-soft);
        color: var(--accent);
        border-radius: 2px;
        padding: 0 2px;
      }

      .search-no-results {
        text-align: center;
        padding: 1.5rem;
        color: var(--muted);
        font-size: 0.85rem;
      }

      /* ===== CARDS ===== */
      .card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }

      .card-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .card-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: var(--accent-soft);
        color: var(--accent);
        border-radius: 999px;
      }

      /* ===== HOME VIEW ===== */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .stat-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--accent);
        line-height: 1;
      }

      .stat-value.ok { color: var(--ok); }
      .stat-value.warn { color: var(--warn); }
      .stat-value.purple { color: var(--purple); }

      .stat-label {
        font-size: 0.7rem;
        color: var(--muted);
        margin-top: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }

      /* Top Stack */
      .top-stack {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.25rem 0;
      }

      .top-stack-item {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.35rem 0.6rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.8rem;
        color: var(--text);
      }

      .top-stack-item .count {
        color: var(--muted);
        font-size: 0.7rem;
      }

      /* Project Mini Cards */
      .project-mini {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(15, 23, 42, 0.5);
        border-radius: 12px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .project-mini:hover, .project-mini:active {
        background: var(--accent-soft);
        transform: scale(0.98);
      }

      .project-icon {
        width: 40px;
        height: 40px;
        background: var(--accent-soft);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }

      .project-info {
        flex: 1;
        min-width: 0;
      }

      .project-name {
        font-weight: 600;
        font-size: 0.95rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .project-meta {
        font-size: 0.75rem;
        color: var(--muted);
      }

      .project-status {
        font-size: 0.65rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-weight: 500;
      }

      .project-status.production {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .project-status.development {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .project-status.idea {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .project-status.prototype {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .project-status.archived {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
      }

      /* ===== PROJECTS VIEW ===== */
      .project-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .project-card:active {
        transform: scale(0.98);
        border-color: var(--accent);
      }

      .project-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
      }

      .project-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .project-version {
        font-size: 0.7rem;
        color: var(--muted);
        background: var(--bg);
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
      }

      .project-desc {
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .project-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .tag {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--muted);
      }

      .tag.highlight {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--accent-soft);
      }

      .tag.promote {
        border-color: var(--ok);
        color: var(--ok);
        background: rgba(34, 197, 94, 0.15);
        cursor: pointer;
      }

      .tag.promote:active {
        transform: scale(0.95);
      }

      /* ===== PROJECT DETAIL ===== */
      .detail-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .back-btn {
        width: 36px;
        height: 36px;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 1.1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .detail-title {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .detail-section {
        margin-bottom: 1.25rem;
      }

      .detail-section-title {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .stack-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .stack-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.7rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 0.85rem;
      }

      .flow-diagram {
        background: var(--bg);
        border-radius: 12px;
        padding: 1rem;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8rem;
        color: var(--muted);
        overflow-x: auto;
        white-space: pre;
      }

      .command-box {
        background: var(--bg);
        border-radius: 8px;
        padding: 0.6rem 0.8rem;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8rem;
        color: var(--ok);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .command-box::before {
        content: "$";
        color: var(--muted);
      }

      /* ===== STACK VIEW ===== */
      .stack-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        background: var(--bg);
        padding: 0.35rem;
        border-radius: 12px;
        border: 1px solid var(--border);
      }

      .stack-tab {
        flex: 1;
        padding: 0.6rem 0.5rem;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .stack-tab.active {
        background: var(--accent-soft);
        color: var(--accent);
      }

      .stack-tab:active {
        transform: scale(0.97);
      }

      .stack-item-card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        margin-bottom: 0.6rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .stack-item-card:active {
        transform: scale(0.98);
        border-color: var(--accent);
      }

      .stack-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.35rem;
      }

      .stack-item-name {
        font-weight: 600;
        font-size: 0.95rem;
      }

      .stack-item-badge {
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        border-radius: 999px;
        background: var(--bg);
        color: var(--muted);
      }

      .stack-item-desc {
        font-size: 0.8rem;
        color: var(--muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .stack-category {
        margin-bottom: 1.25rem;
      }

      .stack-category-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.6rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .stack-tool {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 0;
        border-bottom: 1px solid var(--border);
      }

      .stack-tool:last-child {
        border-bottom: none;
      }

      .stack-tool-name {
        font-size: 0.9rem;
      }

      .stack-tool-level {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .stack-tool-level:active {
        transform: scale(0.95);
      }

      .level-dominado {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .level-funcional {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .level-basico {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .level-explorando {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      /* ===== CAPTURES VIEW ===== */
      .capture-wrapper {
        position: relative;
        overflow: hidden;
        margin-bottom: 0.6rem;
        border-radius: 12px;
      }

      .capture-delete-bg {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 80px;
        background: var(--danger);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        border-radius: 0 12px 12px 0;
      }

      .capture-item {
        position: relative;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 0.85rem;
        transition: transform 0.2s ease;
        touch-action: pan-y;
        z-index: 1;
      }

      .capture-item.swiping {
        transition: none;
      }

      .capture-item.swiped {
        transform: translateX(-80px);
      }

      .capture-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.4rem;
      }

      .capture-type {
        font-size: 0.7rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        font-weight: 500;
      }

      .capture-type.idea {
        background: rgba(168, 85, 247, 0.15);
        color: var(--purple);
      }

      .capture-type.duda {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .capture-type.bug {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .capture-type.todo {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent);
      }

      .capture-time {
        font-size: 0.7rem;
        color: var(--muted);
      }

      .capture-text {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      /* Markdown styles */
      .capture-text code {
        background: var(--bg);
        padding: 0.1rem 0.3rem;
        border-radius: 4px;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.85em;
        color: var(--ok);
      }

      .capture-text strong {
        color: var(--text);
        font-weight: 600;
      }

      .capture-text em {
        font-style: italic;
        color: var(--muted);
      }

      .capture-text .md-list {
        display: block;
      }

      .smart-link {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.15rem 0.4rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--accent);
        text-decoration: none;
        font-size: 0.8em;
        transition: all 0.15s ease;
      }

      .smart-link:active {
        transform: scale(0.97);
        background: var(--accent-soft);
        padding-left: 0.5rem;
      }

      /* Priority indicator */
      .capture-priority {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.65rem;
        padding: 0.1rem 0.35rem;
        border-radius: 4px;
        margin-left: 0.5rem;
      }

      .capture-priority.high {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
      }

      .capture-priority.medium {
        background: rgba(245, 158, 11, 0.15);
        color: var(--warn);
      }

      .capture-priority.low {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .capture-project {
        font-size: 0.75rem;
        color: var(--muted);
        margin-top: 0.35rem;
      }

      .capture-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.6rem;
        padding-top: 0.6rem;
        border-top: 1px dashed var(--border);
      }

      .capture-action {
        flex: 1;
        padding: 0.4rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--muted);
        font-size: 0.75rem;
        cursor: pointer;
        text-align: center;
        transition: all 0.15s ease;
      }

      .capture-action:active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--muted);
      }

      .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      /* ===== BACKUP BUTTONS ===== */
      .backup-btn {
        flex: 1;
        padding: 0.6rem 0.8rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 10px;
        color: var(--text);
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .backup-btn:active {
        background: var(--accent-soft);
        border-color: var(--accent);
        transform: scale(0.98);
      }

      /* API Status indicator */
      .api-status {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        border-radius: 999px;
      }

      .api-status.online {
        background: rgba(34, 197, 94, 0.15);
        color: var(--ok);
      }

      .api-status.offline {
        background: rgba(100, 116, 139, 0.15);
        color: #64748b;
      }

      /* ===== FILTER PILLS ===== */
      .filter-pills {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        overflow-x: auto;
        padding-bottom: 0.25rem;
      }

      .filter-pill {
        padding: 0.35rem 0.75rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 999px;
        color: var(--muted);
        font-size: 0.75rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s ease;
      }

      .filter-pill.active {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      .filter-pill:active {
        transform: scale(0.95);
      }

      /* ===== FAB ===== */
      .fab-container {
        position: fixed;
        bottom: calc(4.5rem + env(safe-area-inset-bottom));
        right: 1rem;
        z-index: 100;
        display: flex;
        flex-direction: column-reverse;
        align-items: center;
        gap: 0.75rem;
      }

      .fab {
        width: 56px;
        height: 56px;
        background: var(--accent);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        transition: all 0.2s ease;
      }

      .fab:active {
        transform: scale(0.9);
      }

      .fab.rotate {
        transform: rotate(45deg);
      }

      .fab-menu {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: all 0.2s ease;
      }

      .fab-container.open .fab-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .fab-option {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 0.5rem 1rem;
        color: var(--text);
        font-size: 0.85rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.15s ease;
      }

      .fab-option:active {
        transform: scale(0.95);
        background: var(--accent-soft);
      }

      /* ===== BOTTOM NAV ===== */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg-soft);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        padding: 0.5rem 0;
        padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
        z-index: 1000;
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.2rem;
        padding: 0.4rem 1rem;
        color: var(--muted);
        text-decoration: none;
        font-size: 0.65rem;
        cursor: pointer;
        transition: all 0.15s ease;
        border-radius: 8px;
      }

      .nav-item.active {
        color: var(--accent);
      }

      .nav-item-icon {
        font-size: 1.3rem;
      }

      /* ===== MODAL ===== */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: flex-end;
        justify-content: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
      }

      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 20px 20px 0 0;
        padding: 1.25rem;
        width: 100%;
        max-width: 500px;
        max-height: 85vh;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }

      .modal-overlay.show .modal {
        transform: translateY(0);
      }

      .modal-handle {
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 999px;
        margin: 0 auto 1rem;
      }

      .modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
      }

      .capture-types {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
      }

      .capture-type-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.3rem;
        padding: 0.75rem 0.5rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 12px;
        color: var(--muted);
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .capture-type-btn.selected {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: var(--accent);
      }

      .capture-type-btn-icon {
        font-size: 1.3rem;
      }

      .modal textarea {
        width: 100%;
        min-height: 100px;
        padding: 0.75rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text);
        font-size: 1rem;
        resize: none;
        outline: none;
        font-family: inherit;
      }

      .modal textarea:focus {
        border-color: var(--accent);
      }

      /* Modal Zen Mode - when keyboard is open */
      .modal.zen-mode {
        max-height: none;
        height: auto;
      }

      .modal.zen-mode .capture-types {
        display: none;
      }

      .modal.zen-mode .modal-title {
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .modal.zen-mode textarea {
        min-height: 80px;
      }

      .modal textarea::placeholder {
        color: var(--muted);
      }

      .modal-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
      }

      .modal-btn {
        flex: 1;
        padding: 0.85rem;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.15s ease;
      }

      .modal-btn.secondary {
        background: var(--bg);
        color: var(--muted);
        border: 1px solid var(--border);
      }

      .modal-btn.primary {
        background: var(--accent);
        color: white;
      }

      .modal-btn:active {
        transform: scale(0.98);
      }

      /* Detail Modal */
      .detail-section {
        margin-bottom: 1rem;
      }

      .detail-section-title {
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.4rem;
      }

      .detail-content {
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .detail-code {
        background: var(--bg);
        border-radius: 8px;
        padding: 0.75rem;
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8rem;
        overflow-x: auto;
        white-space: pre-wrap;
        color: var(--ok);
      }

      .detail-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .detail-tag {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--muted);
      }

      /* Draft form */
      .draft-form-group {
        margin-bottom: 1rem;
      }

      .draft-form-group label {
        display: block;
        font-size: 0.75rem;
        color: var(--muted);
        text-transform: uppercase;
        margin-bottom: 0.35rem;
      }

      .draft-form-group input {
        width: 100%;
        padding: 0.65rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 0.9rem;
      }

      .draft-form-group input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .draft-stack-selector {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
      }

      .draft-stack-chip {
        font-size: 0.75rem;
        padding: 0.3rem 0.55rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .draft-stack-chip.selected {
        background: var(--accent-soft);
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Capture selectors (project + priority) */
      .capture-selectors {
        display: flex;
        gap: 0.75rem;
        margin-top: 0.75rem;
      }

      .capture-selector {
        flex: 1;
      }

      .capture-selector label {
        display: block;
        font-size: 0.7rem;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0.35rem;
      }

      .capture-selector select {
        width: 100%;
        padding: 0.5rem;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 0.85rem;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        padding-right: 1.5rem;
      }

      .capture-selector select:focus {
        border-color: var(--accent);
      }

      .priority-btns {
        display: flex;
        gap: 0.35rem;
      }

      .priority-btn {
        flex: 1;
        padding: 0.45rem;
        background: var(--bg);
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .priority-btn.selected {
        border-color: var(--accent);
        background: var(--accent-soft);
      }

      .priority-btn:active {
        transform: scale(0.95);
      }

      /* Hide selectors in zen mode */
      .modal.zen-mode .capture-selectors {
        display: none;
      }

      /* ===== TOAST ===== */
      .toast {
        position: fixed;
        bottom: 6rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--bg-soft);
        border: 1px solid var(--ok);
        color: var(--ok);
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        font-size: 0.85rem;
        z-index: 3000;
        opacity: 0;
        transition: all 0.3s ease;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      /* ===== UTILITIES ===== */
      .section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }

      .divider {
        height: 1px;
        background: var(--border);
        margin: 1rem 0;
      }

      /* Hide scrollbar but keep functionality */
      .view::-webkit-scrollbar {
        display: none;
      }
      .view {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <!-- ===== HEADER ===== -->
      <header class="header">
        <div class="header-top">
          <h1>‚òï minerOS</h1>
          <span class="status-pill">
            <span class="dot"></span>
            <span>Online</span>
          </span>
        </div>
        <div class="header-date" id="headerDate"></div>

        <!-- Search Bar -->
        <div class="search-bar">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" id="globalSearch" placeholder="Buscar proyectos, tools, capturas..." autocomplete="off" />
          <button class="search-clear" id="searchClear" onclick="clearSearch()">‚úï</button>
          <div class="search-results" id="searchResults"></div>
        </div>
      </header>

      <!-- ===== HOME VIEW ===== -->
      <div class="view active" id="viewHome">
        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value ok" id="statProduction">0</div>
            <div class="stat-label">Production</div>
          </div>
          <div class="stat-card">
            <div class="stat-value purple" id="statPrototype">0</div>
            <div class="stat-label">Prototype</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statTools">0</div>
            <div class="stat-label">Tools</div>
          </div>
          <div class="stat-card">
            <div class="stat-value warn" id="statFlows">0</div>
            <div class="stat-label">Flows</div>
          </div>
        </div>

        <!-- Top Stack -->
        <div class="card" id="topStackCard">
          <div class="card-header">
            <span class="card-title">üîß Stack principal</span>
          </div>
          <div class="top-stack" id="topStack"></div>
        </div>

        <!-- Recent Projects -->
        <div class="section-title">üî• En progreso</div>
        <div id="recentProjects"></div>

        <!-- Recent Captures -->
        <div class="section-title" style="margin-top: 1.25rem;">üí° Capturas recientes</div>
        <div id="recentCaptures"></div>
      </div>

      <!-- ===== PROJECTS VIEW ===== -->
      <div class="view" id="viewProjects">
        <div class="section-title">üìÅ Todos los proyectos</div>
        <div class="filter-pills">
          <span class="filter-pill active" data-filter="all" onclick="setProjectFilter('all')">Todos</span>
          <span class="filter-pill" data-filter="production" onclick="setProjectFilter('production')">Production</span>
          <span class="filter-pill" data-filter="prototype" onclick="setProjectFilter('prototype')">Prototype</span>
          <span class="filter-pill" data-filter="archived" onclick="setProjectFilter('archived')">Archived</span>
          <span class="filter-pill" data-filter="draft" onclick="setProjectFilter('draft')">üìù Bocetos</span>
        </div>
        <div id="projectsList"></div>
      </div>

      <!-- ===== PROJECT DETAIL VIEW ===== -->
      <div class="view" id="viewProjectDetail">
        <div class="detail-header">
          <button class="back-btn" onclick="showView('projects')">‚Üê</button>
          <span class="detail-title" id="detailTitle">Proyecto</span>
        </div>
        <div id="projectDetailContent"></div>
      </div>

      <!-- ===== STACK VIEW ===== -->
      <div class="view" id="viewStack">
        <!-- Tabs -->
        <div class="stack-tabs">
          <button class="stack-tab active" data-tab="tools" onclick="setStackTab('tools')">üîß Tools</button>
          <button class="stack-tab" data-tab="patterns" onclick="setStackTab('patterns')">üß© Patterns</button>
          <button class="stack-tab" data-tab="flows" onclick="setStackTab('flows')">‚ö° Flows</button>
        </div>

        <!-- Tab Content -->
        <div id="stackContent"></div>

        <!-- DirectOS Sync Section -->
        <div class="card" style="margin-top: 1.5rem;">
          <div class="card-header">
            <span class="card-title">üîó DirectOS API</span>
            <span class="api-status" id="apiStatus">‚ö™ Offline</span>
          </div>
          <p style="font-size: 0.8rem; color: var(--muted); margin: 0.5rem 0;">
            Sincroniza desde DirectOS (localhost:8000)
          </p>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
            <button class="backup-btn" onclick="syncWithAPI()" style="flex: 1;">üîÑ Sincronizar</button>
          </div>
        </div>

        <!-- Backup Section -->
        <div class="card" style="margin-top: 1rem;">
          <div class="card-header">
            <span class="card-title">üíæ Backup de datos</span>
          </div>
          <p style="font-size: 0.8rem; color: var(--muted); margin: 0.5rem 0;">
            Exporta tus capturas y configuraci√≥n para no perderlas.
          </p>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
            <button class="backup-btn" onclick="exportData()">üì§ Exportar</button>
            <button class="backup-btn" onclick="document.getElementById('importFile').click()">üì• Importar</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
          </div>
        </div>
      </div>

      <!-- ===== CAPTURES VIEW ===== -->
      <div class="view" id="viewCaptures">
        <div class="section-title">üí° Capturas</div>
        <div id="capturesList"></div>
      </div>

      <!-- ===== FAB ===== -->
      <div class="fab-container" id="fabContainer">
        <button class="fab" id="fabBtn" onclick="toggleFab()">+</button>
        <div class="fab-menu">
          <div class="fab-option" onclick="openCaptureModal(); closeFab();">üí° Nueva captura</div>
          <div class="fab-option" onclick="openDraftModal(); closeFab();">üìù Nuevo proyecto</div>
        </div>
      </div>

      <!-- ===== BOTTOM NAV ===== -->
      <nav class="bottom-nav">
        <div class="nav-item active" data-view="home" onclick="showView('home')">
          <span class="nav-item-icon">üè†</span>
          <span>Home</span>
        </div>
        <div class="nav-item" data-view="projects" onclick="showView('projects')">
          <span class="nav-item-icon">üìÅ</span>
          <span>Proyectos</span>
        </div>
        <div class="nav-item" data-view="stack" onclick="showView('stack')">
          <span class="nav-item-icon">üõ†Ô∏è</span>
          <span>Stack</span>
        </div>
        <div class="nav-item" data-view="captures" onclick="showView('captures')">
          <span class="nav-item-icon">üí°</span>
          <span>Capturas</span>
        </div>
      </nav>

      <!-- ===== CAPTURE MODAL ===== -->
      <div class="modal-overlay" id="captureModal">
        <div class="modal">
          <div class="modal-handle"></div>
          <div class="modal-title">Nueva captura</div>

          <div class="capture-types">
            <button class="capture-type-btn selected" data-type="idea" onclick="selectCaptureType('idea')">
              <span class="capture-type-btn-icon">üí°</span>
              <span>Idea</span>
            </button>
            <button class="capture-type-btn" data-type="duda" onclick="selectCaptureType('duda')">
              <span class="capture-type-btn-icon">‚ùì</span>
              <span>Duda</span>
            </button>
            <button class="capture-type-btn" data-type="bug" onclick="selectCaptureType('bug')">
              <span class="capture-type-btn-icon">üêõ</span>
              <span>Bug</span>
            </button>
            <button class="capture-type-btn" data-type="todo" onclick="selectCaptureType('todo')">
              <span class="capture-type-btn-icon">üìã</span>
              <span>TODO</span>
            </button>
          </div>

          <textarea id="captureText" placeholder="Escribe aqu√≠ tu idea, duda, bug o tarea...&#10;&#10;Soporta **negrita**, *cursiva*, `c√≥digo` y listas con -"></textarea>

          <!-- Project & Priority selectors -->
          <div class="capture-selectors">
            <div class="capture-selector">
              <label>Proyecto</label>
              <select id="captureProject">
                <option value="">Auto-detectar</option>
              </select>
            </div>
            <div class="capture-selector">
              <label>Prioridad</label>
              <div class="priority-btns">
                <button class="priority-btn low selected" data-priority="low" onclick="selectPriority('low')">üü¢</button>
                <button class="priority-btn medium" data-priority="medium" onclick="selectPriority('medium')">üü°</button>
                <button class="priority-btn high" data-priority="high" onclick="selectPriority('high')">üî¥</button>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeCaptureModal()">Cancelar</button>
            <button class="modal-btn primary" onclick="saveCapture()">Guardar</button>
          </div>
        </div>
      </div>

      <!-- ===== DETAIL MODAL ===== -->
      <div class="modal-overlay" id="detailModal">
        <div class="modal">
          <div class="modal-handle"></div>
          <div class="modal-title" id="detailTitle">Detalle</div>
          <div id="detailContent"></div>
          <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeDetailModal()">Cerrar</button>
          </div>
        </div>
      </div>

      <!-- ===== DRAFT MODAL ===== -->
      <div class="modal-overlay" id="draftModal">
        <div class="modal">
          <div class="modal-handle"></div>
          <div class="modal-title">üìù Nuevo Proyecto (Boceto)</div>

          <div class="draft-form-group">
            <label>Nombre</label>
            <input type="text" id="draftName" placeholder="Nombre del proyecto...">
          </div>

          <div class="draft-form-group">
            <label>Idea / Problema</label>
            <textarea id="draftIdea" placeholder="¬øQu√© problema resuelve? ¬øCu√°l es la idea principal?"></textarea>
          </div>

          <div class="draft-form-group">
            <label>Stack inicial (opcional)</label>
            <div class="draft-stack-selector" id="draftStackSelector"></div>
          </div>

          <div class="modal-actions">
            <button class="modal-btn secondary" onclick="closeDraftModal()">Cancelar</button>
            <button class="modal-btn primary" onclick="saveDraft()">Guardar boceto</button>
          </div>
        </div>
      </div>

      <!-- ===== TOAST ===== -->
      <div class="toast" id="toast">Guardado</div>
    </div>

    <script>
      // ============================================
      // minerOS Dashboard Mobile
      // KISS: Simple, debuggeable, funcional
      // ============================================

      const STORAGE_KEY = 'mineros-dashboard-v2';

      // ===== API CONFIG =====
      // Auto-detect: si accedes desde otro dispositivo, usa la misma IP pero puerto 8000
      const API_HOST = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
        ? 'localhost'
        : window.location.hostname;

      const API_CONFIG = {
        baseUrl: `http://${API_HOST}:8000`,
        endpoints: {
          health: '/api/health',
          projects: '/api/projects',
          project: '/api/projects/',  // + id
          tools: '/api/tools',
          patterns: '/api/patterns',
          flows: '/api/flows',
          stats: '/api/content/stats'
        },
        timeout: 5000
      };

      let apiAvailable = false;
      let TOOLS = [];
      let PATTERNS = [];
      let FLOWS = [];

      // ===== DATA =====
      // Proyectos locales como fallback (si DirectOS no est√° corriendo)
      let PROJECTS = [
        {
          id: 'farmaia',
          name: 'farmaIA',
          icon: 'üíä',
          version: 'v5.0',
          status: 'production',
          description: 'Mi Botiqu√≠n Inteligente - Backend Node.js/Express + SQLite + CIMA API (25K+ medicamentos)',
          stack: ['Node.js', 'Express', 'SQLite', 'Claude API', 'SSE'],
          flow: 'User ‚Üí Frontend ‚Üí Backend ‚Üí CIMA API ‚Üí Claude ‚Üí SSE ‚Üí User',
          commands: ['node backend/server.js', 'open frontend/index.html'],
          repo: '~/Desktop/farmaia',
          lastActivity: 0
        },
        {
          id: 'photomine',
          name: 'PhotoMine',
          icon: 'üì∏',
          version: 'v1.4',
          status: 'production',
          description: 'Organizaci√≥n de fotos para localizadores con IA (CLIP) + Dashboard Web + Validaci√≥n Interactiva',
          stack: ['Python', 'CLIP', 'SQLite', 'Flask', 'OpenCV'],
          flow: 'Fotos ‚Üí EXIF ‚Üí CLIP Analysis ‚Üí SQLite ‚Üí Dashboard',
          commands: ['python main.py --input ~/Fotos', 'python web_app.py'],
          repo: '~/Desktop/photomine',
          lastActivity: 1
        },
        {
          id: 'directos',
          name: 'DirectOS',
          icon: 'üß†',
          version: 'v8.0',
          status: 'production',
          description: 'Sistema operativo personal de conocimiento. Dashboard para herramientas, patterns, flows y proyectos',
          stack: ['FastAPI', 'Python', 'HTMX', 'Markdown', 'SQLite'],
          flow: 'Markdown ‚Üí ContentManager ‚Üí FastAPI ‚Üí JSON API',
          commands: ['./start.sh', 'uvicorn main:app --reload'],
          repo: '~/Desktop/DirectOS',
          lastActivity: 0
        },
        {
          id: 'docmine',
          name: 'DocMine',
          icon: 'üìÑ',
          version: 'v0.3.0',
          status: 'archived',
          description: 'Organizador de documentos legales con clasificaci√≥n autom√°tica y dashboard web. Metodolog√≠a ORO-GEMAS-TESORO',
          stack: ['Python', 'Flask', 'SQLite', 'spaCy', 'BeautifulSoup'],
          flow: 'Docs ‚Üí Scanner ‚Üí GemaEngine ‚Üí Vault ‚Üí Dashboard',
          commands: ['python main.py scan /ruta', 'python main.py web'],
          repo: '~/Desktop/Mineria de BD/DocMine-OLD',
          lastActivity: 10
        },
        {
          id: 'docmine-fiscal',
          name: 'DocMine Fiscal',
          icon: 'üßæ',
          version: 'v1.0',
          status: 'production',
          description: 'Procesamiento autom√°tico de Modelo 130 con OCR + regex. 93K‚Ç¨ procesados con 100% √©xito',
          stack: ['Python', 'OCR', 'Flask', 'SQLite', 'Tesseract'],
          flow: 'PDFs ‚Üí OCR ‚Üí Regex Parser ‚Üí SQLite ‚Üí Dashboard',
          commands: ['python main.py procesar --input ~/Fiscal/', 'python main.py dashboard'],
          repo: '~/Desktop/docmine-fiscal',
          lastActivity: 5
        },
        {
          id: 'web-scraper-ia',
          name: 'Web Scraper IA',
          icon: 'üï∑Ô∏è',
          version: 'v1.0',
          status: 'production',
          description: 'Web scraping inteligente con Claude para datos estructurados seg√∫n schemas Pydantic',
          stack: ['Python', 'Claude', 'Pydantic', 'HTTPX', 'BeautifulSoup'],
          flow: 'URL ‚Üí HTTPX ‚Üí BeautifulSoup ‚Üí Claude ‚Üí Pydantic ‚Üí SQLite',
          commands: ['python main.py scrape URL -s product', 'python main.py stats'],
          repo: '~/Desktop/obtener datos de web',
          lastActivity: 2
        },
        {
          id: 'simulaciones-maz',
          name: 'Simulaciones MAZ',
          icon: 'üìà',
          version: 'v1.0',
          status: 'production',
          description: 'Simulaci√≥n financiera Monte Carlo para proyecciones presupuestarias. 3 m√≥dulos de an√°lisis',
          stack: ['HTML', 'JavaScript', 'Chart.js', 'Monte Carlo'],
          flow: 'Datos ‚Üí Monte Carlo (10K iter) ‚Üí Chart.js ‚Üí Reportes',
          commands: ['open "Dashboard Financiero MAZ.html"', 'python -m http.server 8080'],
          repo: '~/Desktop/Simulaciones',
          lastActivity: 3
        },
        {
          id: 'mineros2',
          name: 'minerOS v2 Backend',
          icon: '‚õèÔ∏è',
          version: 'v0.1.0',
          status: 'prototype',
          description: 'Backend API scaffold con FastAPI + ChromaDB persistente. Arquitectura ORO-GEMAS-TESORO',
          stack: ['FastAPI', 'ChromaDB', 'Python', 'Pydantic', 'Uvicorn'],
          flow: 'Files ‚Üí Ingest API ‚Üí ChromaDB ‚Üí Semantic Search',
          commands: ['uvicorn app.main:app --reload', 'curl http://localhost:8000/health'],
          repo: '~/Desktop/MinerOs2',
          lastActivity: 7
        },
        {
          id: 'portfolio-dibujo',
          name: 'Portfolio Dibujo',
          icon: 'üé®',
          version: 'v1.0',
          status: 'prototype',
          description: 'Portfolio web est√°tico para artista digital. Galer√≠a responsive generada desde markdown',
          stack: ['HTML', 'CSS', 'Alpine.js', 'Markdown', 'Python'],
          flow: 'projects/*.md ‚Üí Python Generator ‚Üí Static HTML',
          commands: ['python main.py build', 'python main.py serve'],
          repo: '~/Desktop/portfolio-dibujo',
          lastActivity: 8
        },
        {
          id: 'limpiador-pdfs',
          name: 'Limpiador PDFs',
          icon: 'üßπ',
          version: 'v1.0',
          status: 'archived',
          description: 'Herramienta GUI para limpieza batch de PDFs: metadata, compresi√≥n, extracci√≥n de p√°ginas',
          stack: ['Python', 'tkinter', 'PyMuPDF', 'PyPDF'],
          flow: 'PDFs ‚Üí GUI tkinter ‚Üí Operaciones ‚Üí Output',
          commands: ['python limpiador_pdfs.py'],
          repo: '~',
          lastActivity: 15
        },
        {
          id: 'dashboard-seguimiento',
          name: 'Dashboard Mobile',
          icon: 'üì±',
          version: 'v2.0',
          status: 'production',
          description: 'Este dashboard m√≥vil minerOS para consulta r√°pida de proyectos y capturas',
          stack: ['HTML5', 'CSS3', 'JavaScript', 'LocalStorage'],
          flow: 'User ‚Üí Dashboard ‚Üí LocalStorage',
          commands: ['python -m http.server 8080', 'open index.html'],
          repo: '~/Desktop/dashboard-seguimiento',
          lastActivity: 0
        }
      ];

      // ===== API FUNCTIONS =====
      async function checkApiHealth() {
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), API_CONFIG.timeout);

          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.health, {
            signal: controller.signal
          });
          clearTimeout(timeout);

          if (response.ok) {
            const data = await response.json();
            apiAvailable = true;
            console.log('[API] DirectOS conectado:', data.version);
            return data;
          }
        } catch (e) {
          apiAvailable = false;
          console.log('[API] DirectOS no disponible, usando datos locales');
        }
        return null;
      }

      async function fetchProjectsFromAPI() {
        if (!apiAvailable) return null;

        try {
          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.projects);
          if (response.ok) {
            const data = await response.json();
            // Transformar formato API a formato local
            return data.projects.map(p => ({
              id: p.id,
              name: p.name,
              icon: getProjectIcon(p.id, p.stack),
              version: p.version || 'v1.0',
              status: p.status || 'production',
              description: p.description || '',
              stack: p.stack || [],
              flow: p.flow || '',
              commands: p.commands || [],
              repo: p.repo || '',
              lastActivity: 0
            }));
          }
        } catch (e) {
          console.log('[API] Error fetching projects:', e);
        }
        return null;
      }

      async function fetchToolsFromAPI() {
        if (!apiAvailable) return null;
        try {
          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.tools);
          if (response.ok) {
            const data = await response.json();
            return data.tools || data;
          }
        } catch (e) {
          console.log('[API] Error fetching tools:', e);
        }
        return null;
      }

      async function fetchPatternsFromAPI() {
        if (!apiAvailable) return null;
        try {
          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.patterns);
          if (response.ok) {
            const data = await response.json();
            return data.patterns || data;
          }
        } catch (e) {
          console.log('[API] Error fetching patterns:', e);
        }
        return null;
      }

      async function fetchFlowsFromAPI() {
        if (!apiAvailable) return null;
        try {
          const response = await fetch(API_CONFIG.baseUrl + API_CONFIG.endpoints.flows);
          if (response.ok) {
            const data = await response.json();
            return data.flows || data;
          }
        } catch (e) {
          console.log('[API] Error fetching flows:', e);
        }
        return null;
      }

      function getProjectIcon(id, stack) {
        // Mapeo de iconos por proyecto o stack
        const iconMap = {
          'farmaia': 'üíä',
          'photomine': 'üì∏',
          'directos': 'üß†',
          'docmine': 'üìÑ',
          'docmine-fiscal': 'üßæ',
          'web-scraper-ia': 'üï∑Ô∏è',
          'simulaciones-maz': 'üìà',
          'mineros2': '‚õèÔ∏è',
          'portfolio-dibujo': 'üé®',
          'limpiador-pdfs': 'üßπ',
          'dashboard-seguimiento': 'üì±',
          'dashboard-mobile-mineros': 'üì±'
        };

        if (iconMap[id]) return iconMap[id];

        // Fallback por stack
        if (stack?.includes('python') || stack?.includes('flask') || stack?.includes('fastapi')) return 'üêç';
        if (stack?.includes('node') || stack?.includes('express')) return 'üì¶';
        if (stack?.includes('html') || stack?.includes('javascript')) return 'üåê';
        return 'üìÅ';
      }

      async function syncWithAPI() {
        updateApiStatus('checking');
        const health = await checkApiHealth();

        if (health) {
          updateApiStatus('online');

          // Fetch all data in parallel
          const [apiProjects, apiTools, apiPatterns, apiFlows] = await Promise.all([
            fetchProjectsFromAPI(),
            fetchToolsFromAPI(),
            fetchPatternsFromAPI(),
            fetchFlowsFromAPI()
          ]);

          if (apiProjects && apiProjects.length > 0) {
            PROJECTS = apiProjects;
            console.log('[API] Proyectos cargados:', PROJECTS.length);
          }

          if (apiTools && apiTools.length > 0) {
            TOOLS = apiTools;
            console.log('[API] Tools cargados:', TOOLS.length);
          }

          if (apiPatterns && apiPatterns.length > 0) {
            PATTERNS = apiPatterns;
            console.log('[API] Patterns cargados:', PATTERNS.length);
          }

          if (apiFlows && apiFlows.length > 0) {
            FLOWS = apiFlows;
            console.log('[API] Flows cargados:', FLOWS.length);
          }

          renderHome();
          renderProjects();
          renderStack();
          populateProjectDropdown();
          showToast(`Sincronizado: ${PROJECTS.length} proyectos, ${TOOLS.length} tools`);
        } else {
          updateApiStatus('offline');
        }
      }

      function updateApiStatus(status) {
        const el = document.getElementById('apiStatus');
        if (!el) return;

        switch (status) {
          case 'online':
            el.textContent = 'üü¢ Online';
            el.className = 'api-status online';
            break;
          case 'checking':
            el.textContent = 'üîÑ Conectando...';
            el.className = 'api-status';
            break;
          default:
            el.textContent = '‚ö™ Offline';
            el.className = 'api-status offline';
        }
      }

      const STACK = {
        python: {
          title: 'üêç Python',
          tools: [
            { name: 'Flask', level: 'dominado' },
            { name: 'FastAPI', level: 'dominado' },
            { name: 'SQLite', level: 'dominado' },
            { name: 'Pydantic', level: 'funcional' },
            { name: 'BeautifulSoup', level: 'funcional' },
            { name: 'HTTPX', level: 'funcional' }
          ]
        },
        web: {
          title: 'üåê Web',
          tools: [
            { name: 'HTML5', level: 'dominado' },
            { name: 'CSS3 / Grid / Flexbox', level: 'dominado' },
            { name: 'JavaScript ES6+', level: 'dominado' },
            { name: 'HTMX', level: 'funcional' },
            { name: 'Alpine.js', level: 'funcional' },
            { name: 'Chart.js', level: 'funcional' }
          ]
        },
        ia: {
          title: 'ü§ñ IA / ML',
          tools: [
            { name: 'Claude API', level: 'dominado' },
            { name: 'CLIP (OpenAI)', level: 'dominado' },
            { name: 'OCR (Tesseract)', level: 'funcional' },
            { name: 'ChromaDB', level: 'basico' },
            { name: 'Embeddings', level: 'basico' },
            { name: 'spaCy', level: 'explorando' }
          ]
        },
        node: {
          title: 'üì¶ Node.js',
          tools: [
            { name: 'Express.js', level: 'funcional' },
            { name: 'SSE (Server-Sent Events)', level: 'funcional' },
            { name: 'npm', level: 'funcional' }
          ]
        },
        tools: {
          title: '‚öôÔ∏è Herramientas',
          tools: [
            { name: 'Claude Code', level: 'dominado' },
            { name: 'VS Code', level: 'dominado' },
            { name: 'Git', level: 'funcional' },
            { name: 'Terminal / Bash', level: 'funcional' },
            { name: 'Markdown', level: 'dominado' }
          ]
        }
      };

      // ===== STATE =====
      let state = {
        currentView: 'home',
        currentProject: null,
        captureType: 'idea',
        capturePriority: 'low', // low, medium, high
        captures: [],
        drafts: [], // Bocetos de proyectos
        stackLevels: {},
        stackTab: 'tools', // tools, patterns, flows
        projectFilter: 'all' // all, production, prototype, archived, draft
      };

      // ===== SECURITY: Escape HTML to prevent XSS =====
      function escapeHTML(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      // ===== INIT =====
      function init() {
        loadState();
        updateHeaderDate();
        initSearch();
        renderHome();
        renderProjects();
        renderStack();
        renderCaptures();

        // Update date every minute
        setInterval(updateHeaderDate, 60000);

        // Try to sync with DirectOS API (non-blocking)
        syncWithAPI();
      }

      // ===== STORAGE =====
      function loadState() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          state.captures = data.captures || [];
          state.drafts = data.drafts || [];
          state.stackLevels = data.stackLevels || {};
        }
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          captures: state.captures,
          drafts: state.drafts,
          stackLevels: state.stackLevels
        }));
        showToast('Guardado');
      }

      function saveStateSilent() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          captures: state.captures,
          drafts: state.drafts,
          stackLevels: state.stackLevels
        }));
      }

      // ===== NAVIGATION =====
      function showView(viewName) {
        haptic(5); // Light feedback on nav

        // Hide all views
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

        // Show target view
        const targetView = document.getElementById('view' + capitalize(viewName));
        if (targetView) {
          targetView.classList.add('active');
        }

        // Update nav
        document.querySelectorAll('.nav-item').forEach(n => {
          n.classList.toggle('active', n.dataset.view === viewName);
        });

        state.currentView = viewName;

        // Scroll to top
        targetView?.scrollTo(0, 0);
      }

      function showProjectDetail(projectId) {
        const project = PROJECTS.find(p => p.id === projectId);
        if (!project) return;

        state.currentProject = project;
        document.getElementById('detailTitle').textContent = project.icon + ' ' + project.name;

        const content = document.getElementById('projectDetailContent');
        content.innerHTML = `
          <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
              <span class="project-status ${project.status}">${project.status}</span>
              <span class="project-version">${project.version}</span>
            </div>
            <p style="color: var(--muted); font-size: 0.9rem; margin: 0;">${project.description}</p>
            ${project.repo ? `<div style="font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem; font-family: monospace;">üìÇ ${project.repo}</div>` : ''}
          </div>

          <div class="detail-section">
            <div class="detail-section-title">üõ†Ô∏è Stack</div>
            <div class="stack-list">
              ${project.stack.map(s => `<div class="stack-item">${s}</div>`).join('')}
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">üîÑ Flujo</div>
            <div class="flow-diagram">${project.flow}</div>
          </div>

          <div class="detail-section">
            <div class="detail-section-title">‚å®Ô∏è Comandos</div>
            ${project.commands.map(c => `<div class="command-box">${c}</div>`).join('')}
          </div>
        `;

        // Hide nav items active state and show detail view
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('viewProjectDetail').classList.add('active');
      }

      // ===== RENDER FUNCTIONS =====
      function updateHeaderDate() {
        const now = new Date();
        const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
        document.getElementById('headerDate').textContent = now.toLocaleDateString('es-ES', options);
      }

      function renderHome() {
        // Stats by project status
        const production = PROJECTS.filter(p => p.status === 'production').length;
        const prototype = PROJECTS.filter(p => p.status === 'prototype').length;
        const toolsCount = TOOLS.length;
        const flowsCount = FLOWS.length;

        document.getElementById('statProduction').textContent = production;
        document.getElementById('statPrototype').textContent = prototype;
        document.getElementById('statTools').textContent = toolsCount;
        document.getElementById('statFlows').textContent = flowsCount;

        // Top Stack (most used technologies across projects)
        renderTopStack();

        // Recent projects (production first, then by name)
        const recentProjects = [...PROJECTS]
          .filter(p => p.status === 'production' || p.status === 'prototype')
          .slice(0, 3);

        document.getElementById('recentProjects').innerHTML = recentProjects.map(p => `
          <div class="project-mini" onclick="showProjectDetail('${p.id}')">
            <div class="project-icon">${p.icon}</div>
            <div class="project-info">
              <div class="project-name">${escapeHTML(p.name)}</div>
              <div class="project-meta">${p.stack.slice(0, 2).join(' ¬∑ ')}</div>
            </div>
            <span class="project-status ${p.status}">${p.status}</span>
          </div>
        `).join('');

        // Recent captures
        const recentCaptures = state.captures
          .filter(c => !c.processed)
          .slice(0, 2);

        if (recentCaptures.length === 0) {
          document.getElementById('recentCaptures').innerHTML = `
            <div style="text-align: center; padding: 1rem; color: var(--muted); font-size: 0.85rem;">
              Sin capturas pendientes
            </div>
          `;
        } else {
          document.getElementById('recentCaptures').innerHTML = recentCaptures.map(c => `
            <div class="capture-item">
              <div class="capture-header">
                <span>
                  <span class="capture-type ${c.type}">${getTypeEmoji(c.type)} ${c.type}</span>
                  ${c.priority && c.priority !== 'low' ? `<span class="capture-priority ${c.priority}">${getPriorityEmoji(c.priority)}</span>` : ''}
                </span>
                <span class="capture-time">${formatTime(c.timestamp)}</span>
              </div>
              <div class="capture-text">${renderMarkdown(c.text)}</div>
            </div>
          `).join('');
        }
      }

      function renderTopStack() {
        const topStack = getTopStack(5);
        const el = document.getElementById('topStack');

        if (topStack.length === 0) {
          el.innerHTML = '<span style="color: var(--muted); font-size: 0.85rem;">Sincroniza con DirectOS para ver tu stack</span>';
          return;
        }

        el.innerHTML = topStack.map(([tech, count]) => `
          <span class="top-stack-item">${escapeHTML(tech)} <span class="count">(${count})</span></span>
        `).join('');
      }

      function getTopStack(limit = 5) {
        const counts = {};
        PROJECTS.forEach(p => {
          (p.stack || []).forEach(tech => {
            const normalized = tech.toLowerCase();
            counts[tech] = (counts[tech] || 0) + 1;
          });
        });
        return Object.entries(counts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, limit);
      }

      function renderProjects() {
        // Filter projects based on state.projectFilter
        let filtered = [];

        if (state.projectFilter === 'draft') {
          // Show only drafts
          filtered = state.drafts;
        } else if (state.projectFilter === 'all') {
          filtered = PROJECTS;
        } else {
          filtered = PROJECTS.filter(p => p.status === state.projectFilter);
        }

        let html = '';

        // Show drafts section if on 'all' or 'draft' filter
        if (state.projectFilter === 'all' && state.drafts.length > 0) {
          html += `<div class="section-title" style="margin-bottom: 0.75rem;">üìù Bocetos</div>`;
          html += state.drafts.map(d => `
            <div class="project-card" style="border-left: 3px solid var(--warn);">
              <div class="project-card-header">
                <span class="project-card-title">üìù ${escapeHTML(d.name)}</span>
                <span class="project-status" style="background: rgba(245, 158, 11, 0.15); color: var(--warn);">boceto</span>
              </div>
              <div class="project-desc">${escapeHTML(d.idea || 'Sin descripci√≥n')}</div>
              <div class="project-tags">
                ${d.stack.slice(0, 3).map(s => `<span class="tag">${escapeHTML(s)}</span>`).join('')}
                <span class="tag promote" onclick="event.stopPropagation(); promoteDraft('${d.id}')">üöÄ Crear proyecto</span>
                <span class="tag" style="color: var(--muted); cursor: pointer;" onclick="event.stopPropagation(); deleteDraft('${d.id}')">üóëÔ∏è</span>
              </div>
            </div>
          `).join('');
          html += `<div class="section-title" style="margin: 1rem 0 0.75rem;">üìÅ Proyectos</div>`;
        }

        if (state.projectFilter === 'draft') {
          if (filtered.length === 0) {
            document.getElementById('projectsList').innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <p>Sin bocetos</p>
                <p style="font-size: 0.8rem;">Usa el bot√≥n + para crear un boceto</p>
              </div>
            `;
            return;
          }
          html = filtered.map(d => `
            <div class="project-card" style="border-left: 3px solid var(--warn);">
              <div class="project-card-header">
                <span class="project-card-title">üìù ${escapeHTML(d.name)}</span>
                <span class="project-status" style="background: rgba(245, 158, 11, 0.15); color: var(--warn);">boceto</span>
              </div>
              <div class="project-desc">${escapeHTML(d.idea || 'Sin descripci√≥n')}</div>
              <div class="project-tags">
                ${d.stack.slice(0, 3).map(s => `<span class="tag">${escapeHTML(s)}</span>`).join('')}
                <span class="tag promote" onclick="event.stopPropagation(); promoteDraft('${d.id}')">üöÄ Crear proyecto</span>
                <span class="tag" style="color: var(--muted); cursor: pointer;" onclick="event.stopPropagation(); deleteDraft('${d.id}')">üóëÔ∏è</span>
              </div>
            </div>
          `).join('');
        } else if (filtered.length === 0 && state.projectFilter !== 'all') {
          document.getElementById('projectsList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìÅ</div>
              <p>No hay proyectos con estado "${state.projectFilter}"</p>
            </div>
          `;
          return;
        } else {
          html += filtered.map(p => `
            <div class="project-card" onclick="showProjectDetail('${p.id}')">
              <div class="project-card-header">
                <span class="project-card-title">${p.icon} ${escapeHTML(p.name)}</span>
                <span class="project-status ${p.status}">${p.status}</span>
              </div>
              <div class="project-desc">${escapeHTML(p.description)}</div>
              <div class="project-tags">
                ${(p.stack || []).slice(0, 3).map(s => `<span class="tag">${escapeHTML(s)}</span>`).join('')}
                <span class="tag highlight">${p.version}</span>
              </div>
            </div>
          `).join('');
        }

        document.getElementById('projectsList').innerHTML = html;
      }

      function setStackTab(tab) {
        state.stackTab = tab;
        haptic(5);

        // Update tab buttons
        document.querySelectorAll('.stack-tab').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tab);
        });

        renderStack();
      }

      function renderStack() {
        const el = document.getElementById('stackContent');
        const tab = state.stackTab;

        if (tab === 'tools') {
          renderToolsList(el);
        } else if (tab === 'patterns') {
          renderPatternsList(el);
        } else if (tab === 'flows') {
          renderFlowsList(el);
        }
      }

      function renderToolsList(el) {
        if (TOOLS.length === 0) {
          // Fallback to local STACK data
          let html = '';
          for (const [category, data] of Object.entries(STACK)) {
            html += `
              <div class="stack-category">
                <div class="stack-category-title">${data.title}</div>
                ${data.tools.map(tool => {
                  const level = state.stackLevels[tool.name] || tool.level;
                  return `
                    <div class="stack-tool">
                      <span class="stack-tool-name">${tool.name}</span>
                      <span class="stack-tool-level level-${level}" onclick="cycleLevel('${tool.name}')">${level}</span>
                    </div>
                  `;
                }).join('')}
              </div>
            `;
          }
          el.innerHTML = html;
          return;
        }

        // Group tools by category
        const grouped = {};
        TOOLS.forEach(tool => {
          const cat = tool.category || 'Otros';
          if (!grouped[cat]) grouped[cat] = [];
          grouped[cat].push(tool);
        });

        el.innerHTML = Object.entries(grouped).map(([cat, tools]) => `
          <div class="stack-category">
            <div class="stack-category-title">${cat}</div>
            ${tools.map(tool => `
              <div class="stack-item-card" onclick="showToolDetail('${tool.id}')">
                <div class="stack-item-header">
                  <span class="stack-item-name">${escapeHTML(tool.name)}</span>
                  <span class="stack-item-badge">${tool.level || 'learning'}</span>
                </div>
                <div class="stack-item-desc">${escapeHTML(tool.tag || tool.description || '')}</div>
              </div>
            `).join('')}
          </div>
        `).join('');
      }

      function renderPatternsList(el) {
        if (PATTERNS.length === 0) {
          el.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üß©</div>
              <p>Sin patterns cargados</p>
              <p style="font-size: 0.8rem;">Sincroniza con DirectOS para ver tus patterns</p>
            </div>
          `;
          return;
        }

        el.innerHTML = PATTERNS.map(pattern => `
          <div class="stack-item-card" onclick="showPatternDetail('${pattern.id}')">
            <div class="stack-item-header">
              <span class="stack-item-name">${pattern.emoji || 'üß©'} ${escapeHTML(pattern.name)}</span>
            </div>
            <div class="stack-item-desc">${escapeHTML(pattern.problem || '')}</div>
          </div>
        `).join('');
      }

      function renderFlowsList(el) {
        if (FLOWS.length === 0) {
          el.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ö°</div>
              <p>Sin flows cargados</p>
              <p style="font-size: 0.8rem;">Sincroniza con DirectOS para ver tus flows</p>
            </div>
          `;
          return;
        }

        el.innerHTML = FLOWS.map(flow => `
          <div class="stack-item-card" onclick="showFlowDetail('${flow.id}')">
            <div class="stack-item-header">
              <span class="stack-item-name">${flow.emoji || '‚ö°'} ${escapeHTML(flow.title || flow.name || flow.id)}</span>
              <span class="stack-item-badge">${flow.complexity || 'mid'}</span>
            </div>
            <div class="stack-item-desc">${escapeHTML(flow.useCase || flow.description || '')}</div>
          </div>
        `).join('');
      }

      function renderCaptures() {
        const captures = state.captures.filter(c => !c.processed);

        if (captures.length === 0) {
          document.getElementById('capturesList').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üí°</div>
              <p>Sin capturas pendientes</p>
              <p style="font-size: 0.8rem;">Usa el bot√≥n + para a√±adir ideas, dudas o bugs</p>
            </div>
          `;
          return;
        }

        document.getElementById('capturesList').innerHTML = captures.map((c, i) => `
          <div class="capture-wrapper">
            <div class="capture-delete-bg" onclick="deleteCapture(${i})">üóëÔ∏è</div>
            <div class="capture-item" data-index="${i}" data-capture-id="${c.id}">
              <div class="capture-header">
                <span>
                  <span class="capture-type ${c.type}">${getTypeEmoji(c.type)} ${c.type}</span>
                  ${c.priority && c.priority !== 'low' ? `<span class="capture-priority ${c.priority}">${getPriorityEmoji(c.priority)}</span>` : ''}
                </span>
                <span class="capture-time">${formatTime(c.timestamp)}</span>
              </div>
              <div class="capture-text">${renderMarkdown(c.text)}</div>
              ${c.project ? `<div class="capture-project">üìÅ ${escapeHTML(c.project)}</div>` : ''}
              <div class="capture-actions">
                <button class="capture-action" onclick="processCapture(${i}, 'done')">‚úì Hecho</button>
                <button class="capture-action" onclick="processCapture(${i}, 'later')">‚è∞ Luego</button>
                <button class="capture-action" onclick="deleteCapture(${i})">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');

        // Initialize swipe handlers
        initSwipeHandlers();
      }

      // ===== FAB MENU =====
      function toggleFab() {
        const container = document.getElementById('fabContainer');
        const btn = document.getElementById('fabBtn');
        container.classList.toggle('open');
        btn.classList.toggle('rotate');
        haptic(5);
      }

      function closeFab() {
        const container = document.getElementById('fabContainer');
        const btn = document.getElementById('fabBtn');
        container.classList.remove('open');
        btn.classList.remove('rotate');
      }

      // ===== CAPTURES =====
      function openCaptureModal() {
        document.getElementById('captureModal').classList.add('show');
        const textarea = document.getElementById('captureText');
        textarea.focus();

        // Populate project dropdown
        populateProjectDropdown();

        // Setup Zen mode for virtual keyboard
        setupZenMode();
      }

      function closeCaptureModal() {
        document.getElementById('captureModal').classList.remove('show');
        document.getElementById('captureText').value = '';
        document.getElementById('captureProject').value = '';
        selectCaptureType('idea');
        selectPriority('low');

        // Remove Zen mode
        const modal = document.querySelector('#captureModal .modal');
        modal.classList.remove('zen-mode');
      }

      function populateProjectDropdown() {
        const select = document.getElementById('captureProject');
        // Keep first option (Auto-detectar)
        select.innerHTML = '<option value="">Auto-detectar</option>';
        // Add all projects
        PROJECTS.forEach(p => {
          select.innerHTML += `<option value="${p.name}">${p.icon} ${p.name}</option>`;
        });
      }

      function selectPriority(priority) {
        state.capturePriority = priority;
        document.querySelectorAll('.priority-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.priority === priority);
        });
      }

      // Zen Mode: Adjust modal when virtual keyboard appears
      function setupZenMode() {
        const modal = document.querySelector('#captureModal .modal');
        const textarea = document.getElementById('captureText');

        // Use visualViewport API if available
        if (window.visualViewport) {
          const handleResize = () => {
            const viewportHeight = window.visualViewport.height;
            const windowHeight = window.innerHeight;

            // If viewport is significantly smaller, keyboard is likely open
            if (viewportHeight < windowHeight * 0.75) {
              modal.classList.add('zen-mode');
              // Scroll textarea into view
              setTimeout(() => textarea.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            } else {
              modal.classList.remove('zen-mode');
            }
          };

          window.visualViewport.addEventListener('resize', handleResize);

          // Cleanup on modal close
          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (!document.getElementById('captureModal').classList.contains('show')) {
                window.visualViewport.removeEventListener('resize', handleResize);
                observer.disconnect();
              }
            });
          });
          observer.observe(document.getElementById('captureModal'), { attributes: true });
        }

        // Fallback: detect focus on textarea
        textarea.addEventListener('focus', () => {
          setTimeout(() => {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }

      function selectCaptureType(type) {
        state.captureType = type;
        document.querySelectorAll('.capture-type-btn').forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.type === type);
        });
      }

      function saveCapture() {
        const text = document.getElementById('captureText').value.trim();
        if (!text) return;

        // Get selected project or auto-detect
        const selectedProject = document.getElementById('captureProject').value;
        const project = selectedProject || detectProject(text);

        const capture = {
          id: 'cap_' + Date.now(),
          type: state.captureType,
          text: text,
          project: project,
          priority: state.capturePriority,
          timestamp: new Date().toISOString(),
          processed: false
        };

        state.captures.unshift(capture);
        haptic(15); // Feedback on save
        saveState();
        closeCaptureModal();
        renderHome();
        renderCaptures();
      }

      function processCapture(index, action) {
        haptic();
        if (action === 'done') {
          state.captures[index].processed = true;
        }
        saveState();
        renderHome();
        renderCaptures();
      }

      function deleteCapture(index) {
        haptic();
        state.captures.splice(index, 1);
        saveState();
        renderHome();
        renderCaptures();
      }

      // ===== SWIPE TO DELETE =====
      function initSwipeHandlers() {
        const items = document.querySelectorAll('.capture-item[data-index]');

        items.forEach(item => {
          let startX = 0;
          let currentX = 0;
          let isDragging = false;

          item.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isDragging = true;
            item.classList.add('swiping');
            item.classList.remove('swiped');
          }, { passive: true });

          item.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            currentX = e.touches[0].clientX;
            const diff = startX - currentX;

            // Only allow left swipe (positive diff)
            if (diff > 0) {
              const translateX = Math.min(diff, 80);
              item.style.transform = `translateX(-${translateX}px)`;
            }
          }, { passive: true });

          item.addEventListener('touchend', () => {
            isDragging = false;
            item.classList.remove('swiping');

            const diff = startX - currentX;

            if (diff > 50) {
              // Swipe threshold reached - show delete button
              item.classList.add('swiped');
              item.style.transform = '';
              haptic();
            } else {
              // Reset position
              item.style.transform = '';
              item.classList.remove('swiped');
            }
          });

          // Click anywhere on item to reset swipe
          item.addEventListener('click', (e) => {
            if (item.classList.contains('swiped')) {
              e.stopPropagation();
              item.classList.remove('swiped');
            }
          });
        });
      }

      // ===== HAPTIC FEEDBACK =====
      function haptic(duration = 10) {
        if (navigator.vibrate) {
          navigator.vibrate(duration);
        }
      }

      // ===== MARKDOWN B√ÅSICO =====
      // Aplicar DESPU√âS de escapeHTML para seguridad
      function renderMarkdown(text) {
        if (!text) return '';

        // First escape HTML for security
        let safe = escapeHTML(text);

        // Then apply markdown transformations
        safe = safe
          // Bold: **text** or __text__
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/__(.+?)__/g, '<strong>$1</strong>')
          // Italic: *text* or _text_
          .replace(/\*([^*]+)\*/g, '<em>$1</em>')
          .replace(/_([^_]+)_/g, '<em>$1</em>')
          // Code: `code`
          .replace(/`([^`]+)`/g, '<code>$1</code>')
          // Lists: - item (at start of line)
          .replace(/^- (.+)$/gm, '<span class="md-list">‚Ä¢ $1</span>')
          // Smart Links: detect URLs and render with icons
          .replace(/(https?:\/\/[^\s<]+)/g, (url) => renderSmartLink(url))
          // Line breaks
          .replace(/\n/g, '<br>');

        return safe;
      }

      function renderSmartLink(url) {
        const domain = getDomainFromUrl(url);
        const icon = getUrlIcon(domain);
        const label = getUrlLabel(url, domain);
        return `<a href="${url}" target="_blank" rel="noopener" class="smart-link">${icon} ${label}</a>`;
      }

      function getDomainFromUrl(url) {
        try {
          const parsed = new URL(url);
          return parsed.hostname.replace('www.', '');
        } catch {
          return '';
        }
      }

      function getUrlIcon(domain) {
        const icons = {
          'github.com': 'üêô',
          'youtube.com': '‚ñ∂Ô∏è',
          'youtu.be': '‚ñ∂Ô∏è',
          'stackoverflow.com': 'üìö',
          'twitter.com': 'üê¶',
          'x.com': 'üê¶',
          'npmjs.com': 'üì¶',
          'pypi.org': 'üêç',
          'docs.python.org': 'üêç',
          'developer.mozilla.org': 'ü¶ä',
          'anthropic.com': 'ü§ñ',
          'claude.ai': 'ü§ñ',
          'openai.com': 'ü§ñ',
          'notion.so': 'üìù',
          'figma.com': 'üé®',
          'dribbble.com': 'üé®',
          'medium.com': 'üì∞',
          'dev.to': 'üë®‚Äçüíª',
          'localhost': 'üñ•Ô∏è'
        };
        return icons[domain] || 'üîó';
      }

      function getUrlLabel(url, domain) {
        // GitHub: show repo/issue path
        if (domain === 'github.com') {
          const path = url.replace('https://github.com/', '');
          const parts = path.split('/');
          if (parts.length >= 2) {
            // repo/owner or repo/owner/issues/123
            if (parts[2] === 'issues' && parts[3]) {
              return `${parts[0]}/${parts[1]}#${parts[3]}`;
            }
            if (parts[2] === 'pull' && parts[3]) {
              return `${parts[0]}/${parts[1]} PR#${parts[3]}`;
            }
            return `${parts[0]}/${parts[1]}`;
          }
        }

        // YouTube: just show "YouTube"
        if (domain === 'youtube.com' || domain === 'youtu.be') {
          return 'YouTube';
        }

        // StackOverflow: show "SO"
        if (domain === 'stackoverflow.com') {
          return 'StackOverflow';
        }

        // Default: show domain
        return domain.length > 20 ? domain.substring(0, 20) + '...' : domain;
      }

      // ===== GLOBAL SEARCH =====
      let searchTimeout = null;

      function initSearch() {
        const searchInput = document.getElementById('globalSearch');
        const searchResults = document.getElementById('searchResults');
        const searchClear = document.getElementById('searchClear');

        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          searchClear.classList.toggle('visible', query.length > 0);

          clearTimeout(searchTimeout);
          if (query.length < 2) {
            searchResults.classList.remove('active');
            return;
          }

          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 150);
        });

        searchInput.addEventListener('focus', () => {
          const query = searchInput.value.trim();
          if (query.length >= 2) {
            performSearch(query);
          }
        });

        // Close search when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.search-bar')) {
            searchResults.classList.remove('active');
          }
        });
      }

      function clearSearch() {
        const searchInput = document.getElementById('globalSearch');
        const searchResults = document.getElementById('searchResults');
        const searchClear = document.getElementById('searchClear');

        searchInput.value = '';
        searchClear.classList.remove('visible');
        searchResults.classList.remove('active');
        searchInput.focus();
      }

      function performSearch(query) {
        const lowerQuery = query.toLowerCase();
        const results = {
          projects: [],
          tools: [],
          captures: [],
          patterns: [],
          flows: [],
          drafts: []
        };

        // Search projects
        PROJECTS.forEach(p => {
          if (
            p.name.toLowerCase().includes(lowerQuery) ||
            (p.description && p.description.toLowerCase().includes(lowerQuery)) ||
            (p.stack && p.stack.some(s => s.toLowerCase().includes(lowerQuery)))
          ) {
            results.projects.push(p);
          }
        });

        // Search tools
        TOOLS.forEach(t => {
          if (
            t.name.toLowerCase().includes(lowerQuery) ||
            (t.category && t.category.toLowerCase().includes(lowerQuery)) ||
            (t.description && t.description.toLowerCase().includes(lowerQuery))
          ) {
            results.tools.push(t);
          }
        });

        // Search patterns
        PATTERNS.forEach(p => {
          if (
            p.name.toLowerCase().includes(lowerQuery) ||
            (p.description && p.description.toLowerCase().includes(lowerQuery))
          ) {
            results.patterns.push(p);
          }
        });

        // Search flows
        FLOWS.forEach(f => {
          if (
            f.name.toLowerCase().includes(lowerQuery) ||
            (f.description && f.description.toLowerCase().includes(lowerQuery)) ||
            (f.stack && f.stack.some(s => s.toLowerCase().includes(lowerQuery)))
          ) {
            results.flows.push(f);
          }
        });

        // Search captures
        state.captures.forEach(c => {
          if (c.text.toLowerCase().includes(lowerQuery)) {
            results.captures.push(c);
          }
        });

        // Search drafts
        state.drafts.forEach(d => {
          if (
            d.name.toLowerCase().includes(lowerQuery) ||
            (d.idea && d.idea.toLowerCase().includes(lowerQuery)) ||
            (d.stack && d.stack.some(s => s.toLowerCase().includes(lowerQuery)))
          ) {
            results.drafts.push(d);
          }
        });

        renderSearchResults(results, query);
      }

      function renderSearchResults(results, query) {
        const searchResults = document.getElementById('searchResults');
        const total = results.projects.length + results.tools.length + results.captures.length +
                      results.patterns.length + results.flows.length + results.drafts.length;

        if (total === 0) {
          searchResults.innerHTML = `
            <div class="search-no-results">
              No se encontraron resultados para "${escapeHTML(query)}"
            </div>
          `;
          searchResults.classList.add('active');
          return;
        }

        let html = '';

        // Projects
        if (results.projects.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">üìÅ Proyectos</div>
              ${results.projects.slice(0, 4).map(p => `
                <div class="search-result-item" onclick="goToSearchResult('project', '${p.id}')">
                  <span class="search-result-icon">${p.icon || 'üì¶'}</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(p.name, query)}</div>
                    <div class="search-result-meta">${p.status} ¬∑ ${(p.stack || []).slice(0, 2).join(', ')}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Tools
        if (results.tools.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">üîß Tools</div>
              ${results.tools.slice(0, 4).map(t => `
                <div class="search-result-item" onclick="goToSearchResult('tool', '${t.id}')">
                  <span class="search-result-icon">üîß</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(t.name, query)}</div>
                    <div class="search-result-meta">${t.category || ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Patterns
        if (results.patterns.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">üß© Patterns</div>
              ${results.patterns.slice(0, 3).map(p => `
                <div class="search-result-item" onclick="goToSearchResult('pattern', '${p.id}')">
                  <span class="search-result-icon">üß©</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(p.name, query)}</div>
                    <div class="search-result-meta">${(p.description || '').substring(0, 40)}...</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Flows
        if (results.flows.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">‚ö° Flows</div>
              ${results.flows.slice(0, 3).map(f => `
                <div class="search-result-item" onclick="goToSearchResult('flow', '${f.id}')">
                  <span class="search-result-icon">‚ö°</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(f.name, query)}</div>
                    <div class="search-result-meta">${(f.stack || []).slice(0, 2).join(', ')}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Captures
        if (results.captures.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">üí° Capturas</div>
              ${results.captures.slice(0, 3).map(c => `
                <div class="search-result-item" onclick="goToSearchResult('capture', '${c.id}')">
                  <span class="search-result-icon">${getTypeEmoji(c.type)}</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(c.text.substring(0, 50), query)}${c.text.length > 50 ? '...' : ''}</div>
                    <div class="search-result-meta">${c.type} ¬∑ ${formatTime(c.timestamp)}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Drafts
        if (results.drafts.length > 0) {
          html += `
            <div class="search-section">
              <div class="search-section-title">üìù Bocetos</div>
              ${results.drafts.slice(0, 3).map(d => `
                <div class="search-result-item" onclick="goToSearchResult('draft', '${d.id}')">
                  <span class="search-result-icon">üìù</span>
                  <div class="search-result-info">
                    <div class="search-result-name">${highlightMatch(d.name, query)}</div>
                    <div class="search-result-meta">${(d.stack || []).slice(0, 2).join(', ')}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        searchResults.innerHTML = html;
        searchResults.classList.add('active');
      }

      function highlightMatch(text, query) {
        const escaped = escapeHTML(text);
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return escaped.replace(regex, '<span class="search-highlight">$1</span>');
      }

      function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      function goToSearchResult(type, id) {
        // Clear search
        document.getElementById('globalSearch').value = '';
        document.getElementById('searchResults').classList.remove('active');
        document.getElementById('searchClear').classList.remove('visible');

        haptic();

        switch (type) {
          case 'project':
            showProjectDetail(id);
            break;
          case 'tool':
            showView('stack');
            setStackTab('tools');
            setTimeout(() => showToolDetail(id), 100);
            break;
          case 'pattern':
            showView('stack');
            setStackTab('patterns');
            setTimeout(() => showPatternDetail(id), 100);
            break;
          case 'flow':
            showView('stack');
            setStackTab('flows');
            setTimeout(() => showFlowDetail(id), 100);
            break;
          case 'capture':
            showView('captures');
            // Scroll to capture if possible
            setTimeout(() => {
              const captureEl = document.querySelector(`[data-capture-id="${id}"]`);
              if (captureEl) captureEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            break;
          case 'draft':
            showView('projects');
            setProjectFilter('draft');
            break;
        }
      }

      function detectProject(text) {
        const keywords = {
          'farmaIA': ['farmacia', 'medicamento', 'cima', 'botiquin', 'farmaia', 'irpf'],
          'PhotoMine': ['foto', 'clip', 'imagen', 'localizador', 'photomine', 'exif', 'galeria'],
          'DocMine': ['documento', 'docmine', 'legal', 'clasificacion'],
          'DocMine Fiscal': ['fiscal', 'modelo 130', '130', 'hacienda', 'aeat'],
          'DirectOS': ['directos', 'knowledge', 'markdown', 'pattern', 'flow'],
          'Web Scraper IA': ['scraper', 'scraping', 'web', 'pydantic', 'schema'],
          'Simulaciones MAZ': ['simulacion', 'montecarlo', 'presupuesto', 'financiero', 'maz'],
          'minerOS v2': ['mineros', 'chromadb', 'vector', 'embedding'],
          'Portfolio Dibujo': ['portfolio', 'dibujo', 'arte', 'galeria'],
          'Dashboard Mobile': ['dashboard', 'mobile', 'seguimiento']
        };

        const lowerText = text.toLowerCase();
        for (const [project, words] of Object.entries(keywords)) {
          if (words.some(word => lowerText.includes(word))) {
            return project;
          }
        }
        return null;
      }

      // ===== STACK =====
      function cycleLevel(toolName) {
        const levels = ['explorando', 'basico', 'funcional', 'dominado'];
        const currentLevel = state.stackLevels[toolName] ||
          Object.values(STACK).flatMap(c => c.tools).find(t => t.name === toolName)?.level || 'explorando';

        const currentIndex = levels.indexOf(currentLevel);
        const nextIndex = (currentIndex + 1) % levels.length;
        state.stackLevels[toolName] = levels[nextIndex];

        saveState();
        renderStack();
      }

      // ===== HELPERS =====
      function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
      }

      function getTypeEmoji(type) {
        const emojis = { idea: 'üí°', duda: '‚ùì', bug: 'üêõ', todo: 'üìã' };
        return emojis[type] || 'üí°';
      }

      function getPriorityEmoji(priority) {
        const emojis = { high: 'üî¥ Alta', medium: 'üü° Media', low: 'üü¢ Baja' };
        return emojis[priority] || '';
      }

      function formatTime(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'ahora';
        if (diffMins < 60) return diffMins + 'min';
        if (diffHours < 24) return diffHours + 'h';
        if (diffDays < 7) return diffDays + 'd';
        return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
      }

      // ===== DETAIL MODAL =====
      function showToolDetail(id) {
        const tool = TOOLS.find(t => t.id === id);
        if (!tool) return;

        haptic(10);
        document.getElementById('detailTitle').textContent = `üîß ${tool.name}`;

        let html = '';

        if (tool.category) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Categor√≠a</div>
            <div class="detail-content">${escapeHTML(tool.category)}</div>
          </div>`;
        }

        if (tool.description || tool.content) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Por qu√© en minerOS</div>
            <div class="detail-content">${escapeHTML(tool.description || tool.content || '')}</div>
          </div>`;
        }

        if (tool.level) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Nivel</div>
            <div class="detail-content">${tool.level}</div>
          </div>`;
        }

        if (tool.next) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Siguiente paso</div>
            <div class="detail-content">${escapeHTML(tool.next)}</div>
          </div>`;
        }

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('show');
      }

      function showPatternDetail(id) {
        const pattern = PATTERNS.find(p => p.id === id);
        if (!pattern) return;

        haptic(10);
        document.getElementById('detailTitle').textContent = `${pattern.emoji || 'üß©'} ${pattern.name}`;

        let html = '';

        if (pattern.problem) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Problema</div>
            <div class="detail-content">${escapeHTML(pattern.problem)}</div>
          </div>`;
        }

        if (pattern.prompt || pattern.content) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Prompt</div>
            <div class="detail-code">${escapeHTML(pattern.prompt || pattern.content || '')}</div>
          </div>`;
        }

        if (pattern.flowDesc) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Flujo</div>
            <div class="detail-content">${escapeHTML(pattern.flowDesc)}</div>
          </div>`;
        }

        if (pattern.flow && Array.isArray(pattern.flow)) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Stack</div>
            <div class="detail-tags">
              ${pattern.flow.map(t => `<span class="detail-tag">${escapeHTML(t)}</span>`).join('')}
            </div>
          </div>`;
        }

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('show');
      }

      function showFlowDetail(id) {
        const flow = FLOWS.find(f => f.id === id);
        if (!flow) return;

        haptic(10);
        document.getElementById('detailTitle').textContent = `${flow.emoji || '‚ö°'} ${flow.title || flow.name || flow.id}`;

        let html = '';

        if (flow.useCase || flow.description) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Casos de uso</div>
            <div class="detail-content">${escapeHTML(flow.useCase || flow.description || '')}</div>
          </div>`;
        }

        if (flow.flowDesc) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Flujo</div>
            <div class="detail-content">${escapeHTML(flow.flowDesc)}</div>
          </div>`;
        }

        if (flow.stack && Array.isArray(flow.stack)) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Stack t√©cnico</div>
            <div class="detail-tags">
              ${flow.stack.map(t => `<span class="detail-tag">${escapeHTML(t)}</span>`).join('')}
            </div>
          </div>`;
        }

        if (flow.complexity) {
          html += `<div class="detail-section">
            <div class="detail-section-title">Complejidad</div>
            <div class="detail-content">${flow.complexity}</div>
          </div>`;
        }

        document.getElementById('detailContent').innerHTML = html;
        document.getElementById('detailModal').classList.add('show');
      }

      function closeDetailModal() {
        document.getElementById('detailModal').classList.remove('show');
      }

      // ===== DRAFT MODAL =====
      let selectedDraftStack = [];
      const commonStack = ['Python', 'JavaScript', 'FastAPI', 'Flask', 'SQLite', 'HTML/CSS', 'Claude API', 'Node.js'];

      function openDraftModal() {
        haptic(10);
        closeCaptureModal(); // Close capture modal if open

        // Populate stack selector
        const selector = document.getElementById('draftStackSelector');
        selector.innerHTML = commonStack.map(tech => `
          <span class="draft-stack-chip" onclick="toggleDraftStack('${tech}')">${tech}</span>
        `).join('');

        selectedDraftStack = [];
        document.getElementById('draftName').value = '';
        document.getElementById('draftIdea').value = '';
        document.getElementById('draftModal').classList.add('show');
      }

      function closeDraftModal() {
        document.getElementById('draftModal').classList.remove('show');
      }

      function toggleDraftStack(tech) {
        const index = selectedDraftStack.indexOf(tech);
        if (index > -1) {
          selectedDraftStack.splice(index, 1);
        } else {
          selectedDraftStack.push(tech);
        }

        // Update UI
        document.querySelectorAll('.draft-stack-chip').forEach(chip => {
          chip.classList.toggle('selected', selectedDraftStack.includes(chip.textContent));
        });
      }

      function saveDraft() {
        const name = document.getElementById('draftName').value.trim();
        const idea = document.getElementById('draftIdea').value.trim();

        if (!name) {
          showToast('A√±ade un nombre al proyecto');
          return;
        }

        const draft = {
          id: 'draft-' + Date.now(),
          name,
          idea,
          stack: [...selectedDraftStack],
          createdAt: new Date().toISOString(),
          status: 'draft'
        };

        state.drafts.push(draft);
        saveState();
        closeDraftModal();
        renderProjects();
        showToast('Boceto guardado');
        haptic(20);
      }

      function deleteDraft(id) {
        const index = state.drafts.findIndex(d => d.id === id);
        if (index > -1) {
          state.drafts.splice(index, 1);
          saveStateSilent();
          renderProjects();
          showToast('Boceto eliminado');
          haptic(10);
        }
      }

      async function promoteDraft(id) {
        const draft = state.drafts.find(d => d.id === id);
        if (!draft) return;

        haptic(20);

        // Generate project ID from name
        const projectId = draft.name
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');

        // Create markdown content for DirectOS
        const mdContent = `---
id: ${projectId}
name: ${draft.name}
version: v0.1
status: prototype
stack:
${draft.stack.map(s => `  - ${s.toLowerCase()}`).join('\n')}
repo:
description: ${draft.idea || 'Nuevo proyecto'}
---

# ${draft.name}

${draft.idea || 'Descripci√≥n del proyecto.'}

## Flujo de trabajo

1. **TODO:** Definir flujo principal

## Comandos principales

\`\`\`bash
# TODO: A√±adir comandos
\`\`\`

## Arquitectura

\`\`\`
${projectId}/
‚îî‚îÄ‚îÄ TODO: Definir estructura
\`\`\`

### Stack t√©cnico

${draft.stack.map(s => `- **${s}**`).join('\n')}

## Aprendizajes clave

### Lo que funcion√≥ bien

- TODO

### Problemas resueltos

- TODO

## M√©tricas

- **Estado:** En desarrollo
- **Creado desde boceto:** ${new Date().toISOString().split('T')[0]}
`;

        // Try to create project via DirectOS API
        try {
          const response = await fetch(`${API_CONFIG.baseUrl}/api/projects`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              id: projectId,
              name: draft.name,
              content: mdContent
            }),
            signal: AbortSignal.timeout(API_CONFIG.timeout)
          });

          if (response.ok) {
            // Remove draft after successful creation
            const index = state.drafts.findIndex(d => d.id === id);
            if (index > -1) {
              state.drafts.splice(index, 1);
              saveStateSilent();
            }

            // Sync to get new project
            await syncWithAPI();

            showToast('üöÄ Proyecto creado en DirectOS');
            renderProjects();
            renderHome();
          } else {
            throw new Error('API error');
          }
        } catch (error) {
          console.log('DirectOS no disponible, guardando localmente');

          // Add as local project placeholder
          const newProject = {
            id: projectId,
            name: draft.name,
            icon: 'üöß',
            status: 'prototype',
            stack: draft.stack,
            description: draft.idea || 'Nuevo proyecto',
            version: 'v0.1',
            local: true // Mark as local-only
          };

          PROJECTS.unshift(newProject);

          // Remove draft
          const index = state.drafts.findIndex(d => d.id === id);
          if (index > -1) {
            state.drafts.splice(index, 1);
            saveStateSilent();
          }

          showToast('üì¶ Proyecto creado (local)');
          renderProjects();
          renderHome();
        }
      }

      // ===== UTILITY FUNCTIONS =====
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      }

      // ===== BACKUP: EXPORT/IMPORT =====
      function exportData() {
        const data = {
          version: '3.0',
          exportDate: new Date().toISOString(),
          captures: state.captures,
          drafts: state.drafts,
          stackLevels: state.stackLevels
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `mineros-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Backup exportado');
      }

      function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);

            // Validar estructura
            if (!data.captures && !data.stackLevels && !data.drafts) {
              throw new Error('Formato inv√°lido');
            }

            // Merge con datos actuales
            if (data.captures) {
              const existingIds = new Set(state.captures.map(c => c.id));
              const newCaptures = data.captures.filter(c => !existingIds.has(c.id));
              state.captures = [...state.captures, ...newCaptures];
            }

            if (data.drafts) {
              const existingIds = new Set(state.drafts.map(d => d.id));
              const newDrafts = data.drafts.filter(d => !existingIds.has(d.id));
              state.drafts = [...state.drafts, ...newDrafts];
            }

            if (data.stackLevels) {
              state.stackLevels = { ...state.stackLevels, ...data.stackLevels };
            }

            saveState();
            renderHome();
            renderStack();
            renderCaptures();
            renderProjects();
            showToast(`Importado: ${data.captures?.length || 0} capturas`);
          } catch (err) {
            showToast('Error: archivo inv√°lido');
            console.error('Import error:', err);
          }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset input
      }

      // ===== PROJECT FILTERS =====
      function setProjectFilter(filter) {
        state.projectFilter = filter;
        renderProjects();

        // Update active pill
        document.querySelectorAll('.filter-pill').forEach(pill => {
          pill.classList.toggle('active', pill.dataset.filter === filter);
        });
      }

      // Click outside modal to close
      document.getElementById('captureModal').addEventListener('click', (e) => {
        if (e.target.id === 'captureModal') {
          closeCaptureModal();
        }
      });

      // ===== START =====
      document.addEventListener('DOMContentLoaded', init);

      // ===== PWA: Register Service Worker =====
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .then((registration) => {
              console.log('[PWA] Service Worker registered:', registration.scope);

              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New version available
                    if (confirm('Nueva versi√≥n disponible. ¬øActualizar?')) {
                      newWorker.postMessage('skipWaiting');
                      window.location.reload();
                    }
                  }
                });
              });
            })
            .catch((error) => {
              console.log('[PWA] Service Worker registration failed:', error);
            });
        });
      }

      // ===== PWA: Install prompt =====
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Could show a custom install button here
        console.log('[PWA] Install prompt available');
      });
    </script>
  </body>
</html>
